<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏° ‚Ä¢ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Prompt', 'Kanit', sans-serif;
            background: #ffffff;
            min-height: 100%;
            font-weight: 400;
        }
        html, body {
            height: 100%;
        }
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }
        .btn-primary:hover::before {
            left: 100%;
        }
        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }
        .btn-register {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            font-weight: 700;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-register::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }
        .btn-register:hover::before {
            left: 100%;
        }
        .btn-register:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 20px 40px rgba(255, 107, 107, 0.4);
        }
        .btn-cancel {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .btn-cancel:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(231, 76, 60, 0.3);
        }
        .fade-in {
            animation: fadeIn 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(30px) scale(0.95);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }
        h1, h2, h3 {
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .font-medium {
            font-weight: 500;
        }
        .font-bold {
            font-weight: 700;
        }
        input, select {
            font-family: 'Prompt', 'Kanit', sans-serif;
            font-weight: 400;
        }
        .status-success {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            color: white;
            border: none;
        }
        .status-error {
            background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
            color: white;
            border: none;
        }
        .status-info {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            border: none;
        }
    </style>
</head>
<body class="min-h-full">
    <div id="app" class="min-h-full flex flex-col">
        <header class="glass border-b border-white/20 p-4">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <img src="https://img5.pic.in.th/file/secure-sv1/IMG_25650953161d1c1bbdd8.jpeg" 
                         alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="w-12 h-12 rounded-full object-cover">
                    <div>
                        <h1 class="text-gray-800 font-bold text-lg md:text-xl">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
                        <p class="text-gray-600 text-sm">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏° ‡∏™‡∏û‡∏ê. ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á</p>
                    </div>
                </div>
                <button id="logoutBtn" class="hidden bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
        </header>

        <main class="flex-1 p-4">
            <div class="max-w-6xl mx-auto">
                <div id="loginPage" class="fade-in">
                    <div class="max-w-md mx-auto glass rounded-2xl p-8 shadow-2xl">
                        <div class="text-center mb-8">
                            <img src="https://img5.pic.in.th/file/secure-sv1/IMG_25650953161d1c1bbdd8.jpeg" 
                                 alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="w-20 h-20 rounded-full mx-auto mb-4 object-cover">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                            <p class="text-gray-600">Student Morality Leadership Committee</p>
                        </div>

                        <div id="studentLogin" class="space-y-6">
                            <div>
                                <label for="studentId" class="block text-gray-700 font-medium mb-2">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                                <input type="text" id="studentId" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
                            </div>
                            <div>
                                <label for="phoneNumber" class="block text-gray-700 font-medium mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                                <input type="tel" id="phoneNumber" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
                            </div>
                            <button id="studentLoginBtn" class="w-full btn-primary text-white font-bold py-3 px-6 rounded-xl">
                                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                            </button>
                        </div>

                        <div class="my-6 text-center">
                            <span class="text-gray-500">‡∏´‡∏£‡∏∑‡∏≠</span>
                        </div>

                        <button id="adminToggle" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-6 rounded-xl transition-colors border border-gray-300">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•
                        </button>

                        <div id="adminLogin" class="hidden space-y-6 mt-6">
                            <div>
                                <label for="adminEmail" class="block text-gray-700 font-medium mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</label>
                                <input type="email" id="adminEmail" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•">
                            </div>
                            <div>
                                <label for="adminPassword" class="block text-gray-700 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                                <input type="password" id="adminPassword" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                            </div>
                            <button id="adminLoginBtn" class="w-full btn-primary text-white font-bold py-3 px-6 rounded-xl">
                                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•
                            </button>
                        </div>
                    </div>
                </div>

                <div id="studentDashboard" class="hidden fade-in">
                    <div class="max-w-2xl mx-auto glass rounded-2xl p-8 shadow-2xl">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                            <div id="studentInfo" class="bg-blue-50 border border-blue-200 rounded-xl p-6 text-gray-800">
                                </div>
                        </div>

                        <div class="text-center">
                            <div id="countdownTimer" class="mb-6 hidden">
                                </div>
                            <div id="registrationStatus" class="mb-6">
                                </div>
                            <button id="registerBtn" class="btn-register text-white font-bold py-5 px-10 rounded-2xl text-xl shadow-2xl">
                                üéØ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏°
                            </button>
                        </div>
                    </div>
                </div>

                <div id="adminDashboard" class="hidden fade-in space-y-6">
                    <div class="glass rounded-2xl p-6 shadow-2xl">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</h2>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-700 font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="registrationToggle" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                    </label>
                                </div>
                                <button id="csvImportBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-xl transition-colors">
                                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (CSV)
                                </button>
                                <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                                <button id="addStudentBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-4 rounded-xl transition-colors">
                                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
                                </button>
                                <button id="clearStudentsBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-4 rounded-xl transition-colors">
                                    ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
                                    <input type="datetime-local" id="openDateTime" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
                                    <input type="datetime-local" id="closeDateTime" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <button id="setScheduleBtn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-medium py-3 px-4 rounded-xl transition-colors mb-2">
                                    ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                                </button>
                                <button id="clearScheduleBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-4 rounded-xl transition-colors">
                                    ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="glass rounded-2xl p-6 shadow-2xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ <span id="applicantCount" class="text-base font-normal text-gray-500">(0 ‡∏Ñ‡∏ô)</span></h3>
                            <button id="exportBtn" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-gray-800">
                                <thead>
                                    <tr class="border-b border-gray-200 bg-gray-50">
                                        <th class="text-left py-3 px-2 font-semibold">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏ä‡∏±‡πâ‡∏ô</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody id="applicantsTable">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="glass rounded-2xl p-6 shadow-2xl">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="totalStudentsCount" class="text-base font-normal text-gray-500">(0 ‡∏Ñ‡∏ô)</span></h3>
                        
                        <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
                                <input type="text" id="searchStudent" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏´‡∏±‡∏™, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏±‡πâ‡∏ô</label>
                                <select id="filterGrade" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
                                <select id="filterStatus" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                    <option value="applied">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß</option>
                                    <option value="not-applied">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button id="clearFiltersBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                    ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-gray-800">
                                <thead>
                                    <tr class="border-b border-gray-200 bg-gray-50">
                                        <th class="text-left py-3 px-2 font-semibold">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏ä‡∏±‡πâ‡∏ô</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody id="allStudentsTable">
                                    </tbody>
                            </table >
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="glass border-t border-gray-200 p-4 mt-8">
            <div class="grid grid-cols-1 gap-y-2 text-sm w-fit mx-auto">
                <div class="flex items-center space-x-2">
                    <a href="https://spt-moral-school.github.io/terms/#terms" class="text-gray-400 hover:text-purple-400 transition duration-300">‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</a>
                    <p class="text-gray-400">|</p>
                    <a href="https://spt-moral-school.github.io/terms/#policy" class="text-gray-400 hover:text-purple-400 transition duration-300">‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</a>
                </div>
            </div>
            <div class="max-w-6xl mx-auto text-center text-gray-600 text-sm">
                &copy; 2024 SPT MORAL SCHOOL - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏° ‡∏™‡∏û‡∏ê. ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á | All Rights Reserved
            </div>
        </footer>

        <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="glass rounded-2xl p-8 text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <p class="text-gray-800 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            </div>
        </div>

        <div id="addStudentModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="glass rounded-2xl p-8 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-6">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                <form id="addStudentForm" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <input type="text" id="addStudentId" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏±‡πâ‡∏ô</label>
                            <select id="addGrade" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="‡∏°.1">‡∏°.1</option>
                                <option value="‡∏°.2">‡∏°.2</option>
                                <option value="‡∏°.3">‡∏°.3</option>
                                <option value="‡∏°.4">‡∏°.4</option>
                                <option value="‡∏°.5">‡∏°.5</option>
                                <option value="‡∏°.6">‡∏°.6</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡∏´‡πâ‡∏≠‡∏á</label>
                            <select id="addRoom" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                        <select id="addPrefix" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢">‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢</option>
                            <option value="‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á">‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á</option>
                            <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                            <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠</label>
                        <input type="text" id="addFirstName" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="addLastName" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                        <input type="text" id="addNickname" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                        <input type="tel" id="addPhone" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                        </button>
                        <button type="button" id="cancelAddBtn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="editStudentModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="glass rounded-2xl p-8 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-6">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                <form id="editStudentForm" class="space-y-4">
                    <input type="hidden" id="editStudentDocId">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <input type="text" id="editStudentId" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏±‡πâ‡∏ô</label>
                            <select id="editGrade" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="‡∏°.1">‡∏°.1</option>
                                <option value="‡∏°.2">‡∏°.2</option>
                                <option value="‡∏°.3">‡∏°.3</option>
                                <option value="‡∏°.4">‡∏°.4</option>
                                <option value="‡∏°.5">‡∏°.5</option>
                                <option value="‡∏°.6">‡∏°.6</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡∏´‡πâ‡∏≠‡∏á</label>
                            <select id="editRoom" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                        <select id="editPrefix" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢">‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢</option>
                            <option value="‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á">‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á</option>
                            <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                            <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠</label>
                        <input type="text" id="editFirstName" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="editLastName" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                        <input type="text" id="editNickname" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                        <input type="tel" id="editPhone" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                        </button>
                        <button type="button" id="cancelEditBtn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="confirmModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="glass rounded-2xl p-8 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
                <p id="confirmMessage" class="text-gray-700 mb-6"></p>
                <div class="flex space-x-4">
                    <button id="confirmYes" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                    </button>
                    <button id="confirmNo" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDjPKzAY2oyB83jcpXHbBKgK1WZhVmsnHA",
          authDomain: "spt-students.firebaseapp.com",
          projectId: "spt-students",
          storageBucket: "spt-students.firebasestorage.app",
          messagingSenderId: "814089202848",
          appId: "1:814089202848:web:0fa59f182f4feadd702dc5",
          measurementId: "G-MEPRLGW034"
      };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        let currentUser = null;
        let isAdmin = false;
        let registrationOpen = true;

        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const studentDashboard = document.getElementById('studentDashboard');
        const adminDashboard = document.getElementById('adminDashboard');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // Show loading
        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }

        // Hide loading
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Toggle admin login form
        document.getElementById('adminToggle').addEventListener('click', () => {
            const adminLogin = document.getElementById('adminLogin');
            const studentLogin = document.getElementById('studentLogin');
            
            if (adminLogin.classList.contains('hidden')) {
                adminLogin.classList.remove('hidden');
                studentLogin.classList.add('hidden');
                document.getElementById('adminToggle').textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
            } else {
                adminLogin.classList.add('hidden');
                studentLogin.classList.remove('hidden');
                document.getElementById('adminToggle').textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•';
            }
        });

        // Student login
        document.getElementById('studentLoginBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            const studentId = document.getElementById('studentId').value.trim();
            const phoneNumber = document.getElementById('phoneNumber').value.trim();

            if (!studentId || !phoneNumber) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }

            showLoading();
            try {
                // Check if student exists in database
                const studentQuery = await db.collection('applications')
                    .where('studentId', '==', studentId)
                    .where('phone', '==', phoneNumber)
                    .get();

                if (studentQuery.empty) {
                    showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                    hideLoading();
                    return;
                }

                const studentData = studentQuery.docs[0].data();
                currentUser = { ...studentData, docId: studentQuery.docs[0].id };
                isAdmin = false;

                showStudentDashboard();
                hideLoading();
                showNotification('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } catch (error) {
                console.error('Login error:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'error');
                hideLoading();
            }
        });

        // Admin login
        document.getElementById('adminLoginBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value.trim();

            if (!email || !password) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }

            showLoading();
            try {
                await auth.signInWithEmailAndPassword(email, password);
                isAdmin = true;
                showAdminDashboard();
                hideLoading();
                showNotification('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } catch (error) {
                console.error('Admin login error:', error);
                showNotification('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                hideLoading();
            }
        });

        // Show student dashboard
        function showStudentDashboard() {
            loginPage.classList.add('hidden');
            studentDashboard.classList.remove('hidden');
            adminDashboard.classList.add('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');

            // Display student info
            const studentInfo = document.getElementById('studentInfo');
            studentInfo.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                    <div><strong>‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> ${currentUser.studentId}</div>
                    <div><strong>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</strong> ${currentUser.prefix} ${currentUser.firstName} ${currentUser.lastName}</div>
                    <div><strong>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô:</strong> ${currentUser.nickname}</div>
                    <div><strong>‡∏ä‡∏±‡πâ‡∏ô:</strong> ${currentUser.grade}/${currentUser.room}</div>
                    <div><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£:</strong> ${currentUser.phone}</div>
                </div>
            `;

            checkRegistrationStatus();
        }

        // Global countdown timer variable
        let countdownInterval = null;

        // Update countdown timer
        function updateCountdown(targetDate, isOpening = true) {
            const countdownTimer = document.getElementById('countdownTimer');
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }

            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = targetDate.getTime() - now;

                if (distance < 0) {
                    clearInterval(countdownInterval);
                    countdownTimer.classList.add('hidden');
                    checkRegistrationStatus(); // Refresh status
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                const actionText = isOpening ? '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£' : '‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£';
                const bgColor = isOpening ? 'bg-blue-500' : 'bg-orange-500';

                countdownTimer.innerHTML = `
                    <div class="${bgColor} text-white rounded-2xl p-6 shadow-xl">
                        <h3 class="font-bold text-xl mb-3">‚è∞ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤${actionText}</h3>
                        <div class="grid grid-cols-4 gap-4 text-center">
                            <div class="bg-white/20 rounded-lg p-3">
                                <div class="text-2xl font-bold">${days}</div>
                                <div class="text-sm">‡∏ß‡∏±‡∏ô</div>
                            </div>
                            <div class="bg-white/20 rounded-lg p-3">
                                <div class="text-2xl font-bold">${hours}</div>
                                <div class="text-sm">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
                            </div>
                            <div class="bg-white/20 rounded-lg p-3">
                                <div class="text-2xl font-bold">${minutes}</div>
                                <div class="text-sm">‡∏ô‡∏≤‡∏ó‡∏µ</div>
                            </div>
                            <div class="bg-white/20 rounded-lg p-3">
                                <div class="text-2xl font-bold">${seconds}</div>
                                <div class="text-sm">‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
                            </div>
                        </div>
                        <p class="text-sm opacity-90 mt-3">${actionText}: ${targetDate.toLocaleString('th-TH')}</p>
                    </div>
                `;
                countdownTimer.classList.remove('hidden');
            }, 1000);
        }
        
        // MODIFICATION: Helper function to check if registration is currently open
        async function isRegistrationCurrentlyOpen() {
            const settingsDoc = await db.collection('settings').doc('registration').get();
            const settings = settingsDoc.data() || { isOpen: true }; // Default to open if no settings exist

            const now = new Date();
            
            if (settings.openDateTime && settings.closeDateTime) {
                const openTime = settings.openDateTime.toDate();
                const closeTime = settings.closeDateTime.toDate();
                
                return now >= openTime && now <= closeTime;
            } else {
                return !!settings.isOpen;
            }
        }
        // END MODIFICATION

        // Check registration status
        async function checkRegistrationStatus() {
            try {
                const applicantQuery = await db.collection('applicants')
                    .where('studentId', '==', currentUser.studentId)
                    .get();

                const registrationStatus = document.getElementById('registrationStatus');
                const registerBtn = document.getElementById('registerBtn');
                const countdownTimer = document.getElementById('countdownTimer');
                
                // Get current status to enable/disable cancel button
                const registrationIsOpen = await isRegistrationCurrentlyOpen();

                if (!applicantQuery.empty) {
                    const applicantDocId = applicantQuery.docs[0].id;
                    
                    // MODIFICATION: Enable/disable cancel button based on registration status
                    const cancelBtnClass = registrationIsOpen ? 'btn-cancel' : 'bg-gray-400 cursor-not-allowed';
                    const cancelBtnText = registrationIsOpen ? 'üö´ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£' : 'üö´ ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß (‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)';
                    const cancelBtnDisabled = registrationIsOpen ? '' : 'disabled';
                    
                    // If open, call cancelMyApplication, else show error status.
                    const cancelAction = registrationIsOpen 
                        ? `onclick="cancelMyApplication('${applicantDocId}')"` 
                        : `onclick="showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß', 'error')"`;

                    registrationStatus.innerHTML = `
                        <div class="status-success rounded-2xl p-6 shadow-xl">
                            <h3 class="font-bold text-xl mb-3">‚úÖ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</h3>
                            <p class="text-lg mb-2">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                            <p class="text-sm opacity-90 mt-3">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ${applicantQuery.docs[0].data().timestamp?.toDate().toLocaleString('th-TH')}</p>
                            <button ${cancelAction} class="mt-5 ${cancelBtnClass} text-white font-semibold py-3 px-6 rounded-xl transition-all" ${cancelBtnDisabled}>
                                ${cancelBtnText}
                            </button>
                        </div>
                    `;
                    // END MODIFICATION
                    
                    registerBtn.style.display = 'none';
                    countdownTimer.classList.add('hidden');
                    if (countdownInterval) clearInterval(countdownInterval);
                } else {
                    // Check if registration is open and get schedule
                    const settingsDoc = await db.collection('settings').doc('registration').get();
                    const settings = settingsDoc.data() || {};
                    
                    const now = new Date();
                    
                    // Check for scheduled times
                    if (settings.openDateTime && settings.closeDateTime) {
                        const openTime = settings.openDateTime.toDate();
                        const closeTime = settings.closeDateTime.toDate();
                        
                        if (now < openTime) {
                            // Before opening time - show countdown to opening
                            updateCountdown(openTime, true);
                            registrationStatus.innerHTML = `
                                <div class="status-info rounded-2xl p-6 shadow-xl">
                                    <h3 class="font-bold text-xl mb-3">‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h3>
                                    <p class="text-lg">‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</p>
                                </div>
                            `;
                            registerBtn.style.display = 'none';
                        } else if (now >= openTime && now <= closeTime) {
                            // During registration period - show countdown to closing
                            updateCountdown(closeTime, false);
                            registrationStatus.innerHTML = `
                                <div class="status-success rounded-2xl p-6 shadow-xl">
                                    <h3 class="font-bold text-xl mb-3">üìù ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h3>
                                    <p class="text-lg">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏°‡πÑ‡∏î‡πâ</p>
                                </div>
                            `;
                            registerBtn.style.display = 'block';
                        } else {
                            // After closing time
                            countdownTimer.classList.add('hidden');
                            if (countdownInterval) clearInterval(countdownInterval);
                            registrationStatus.innerHTML = `
                                <div class="status-error rounded-2xl p-6 shadow-xl">
                                    <h3 class="font-bold text-xl mb-3">‚ùå ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß</h3>
                                    <p class="text-lg">‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏°</p>
                                </div>
                            `;
                            registerBtn.style.display = 'none';
                        }
                    } else {
                        // Manual control - no scheduled times
                        countdownTimer.classList.add('hidden');
                        if (countdownInterval) clearInterval(countdownInterval);
                        
                        if (!settings.isOpen) {
                            registrationStatus.innerHTML = `
                                <div class="status-error rounded-2xl p-6 shadow-xl">
                                    <h3 class="font-bold text-xl mb-3">‚ùå ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß</h3>
                                    <p class="text-lg">‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏°</p>
                                </div>
                            `;
                            registerBtn.style.display = 'none';
                        } else {
                            registrationStatus.innerHTML = `
                                <div class="status-info rounded-2xl p-6 shadow-xl">
                                    <h3 class="font-bold text-xl mb-3">üìù ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h3>
                                    <p class="text-lg">‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏°‡πÑ‡∏î‡πâ</p>
                                </div>
                            `;
                            registerBtn.style.display = 'block';
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking registration status:', error);
            }
        }

        // Register for committee
        document.getElementById('registerBtn').addEventListener('click', async () => {
            showLoading();
            try {
                await db.collection('applicants').add({
                    studentId: currentUser.studentId,
                    prefix: currentUser.prefix,
                    firstName: currentUser.firstName,
                    lastName: currentUser.lastName,
                    nickname: currentUser.nickname,
                    grade: currentUser.grade,
                    room: currentUser.room,
                    phone: currentUser.phone,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                hideLoading();
                showNotification('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                checkRegistrationStatus();
            } catch (error) {
                console.error('Registration error:', error);
                hideLoading();
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£', 'error');
            }
        });

        // Show admin dashboard
        async function showAdminDashboard() {
            loginPage.classList.add('hidden');
            studentDashboard.classList.add('hidden');
            adminDashboard.classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');

            await loadAdminData();
        }

        // Global variables for filtering
        let allStudentsData = [];
        let applicantIds = new Set();

        // Load admin data
        async function loadAdminData() {
            try {
                // Load settings
                const settingsDoc = await db.collection('settings').doc('registration').get();
                const settings = settingsDoc.data() || { isOpen: true };
                
                document.getElementById('registrationToggle').checked = settings.isOpen;

                // Load existing schedule if available
                if (settings.openDateTime && settings.closeDateTime) {
                    const openDate = settings.openDateTime.toDate();
                    const closeDate = settings.closeDateTime.toDate();
                    
                    // Format dates for datetime-local input
                    const formatDateTime = (date) => {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');
                        return `${year}-${month}-${day}T${hours}:${minutes}`;
                    };
                    
                    document.getElementById('openDateTime').value = formatDateTime(openDate);
                    document.getElementById('closeDateTime').value = formatDateTime(closeDate);
                }

                // Load applicants
                const applicantsSnapshot = await db.collection('applicants').orderBy('timestamp', 'desc').get();
                const applicantsTable = document.getElementById('applicantsTable');
                applicantsTable.innerHTML = '';
                
                // MODIFICATION: Display total applicant count
                const totalApplicants = applicantsSnapshot.docs.length;
                const applicantCountElement = document.getElementById('applicantCount');
                if (applicantCountElement) {
                    applicantCountElement.textContent = `(${totalApplicants} ‡∏Ñ‡∏ô)`;
                }
                // END MODIFICATION

                // Reset applicant IDs
                applicantIds.clear();

                applicantsSnapshot.forEach(doc => {
                    const data = doc.data();
                    applicantIds.add(data.studentId);
                    
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-2">${data.studentId}</td>
                        <td class="py-3 px-2">${data.prefix} ${data.firstName} ${data.lastName}</td>
                        <td class="py-3 px-2">${data.grade}/${data.room}</td>
                        <td class="py-3 px-2">${data.phone}</td>
                        <td class="py-3 px-2">${data.timestamp?.toDate().toLocaleString('th-TH') || 'N/A'}</td>
                        <td class="py-3 px-2">
                            <button onclick="cancelApplication('${doc.id}', '${data.studentId}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                            </button>
                        </td>
                    `;
                    applicantsTable.appendChild(row);
                });

                // Load all students
                const studentsSnapshot = await db.collection('applications').get();
                allStudentsData = [];
                const grades = new Set();

                studentsSnapshot.forEach(doc => {
                    const data = { ...doc.data(), docId: doc.id };
                    allStudentsData.push(data);
                    if (data.grade) grades.add(data.grade);
                });

                // Populate grade filter
                const gradeFilter = document.getElementById('filterGrade');
                gradeFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>';
                Array.from(grades).sort().forEach(grade => {
                    gradeFilter.innerHTML += `<option value="${grade}">‡∏°.${grade}</option>`;
                });

                // Display filtered students
                displayFilteredStudents();

            } catch (error) {
                console.error('Error loading admin data:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        }

        // Display filtered students
        function displayFilteredStudents() {
            const searchTerm = document.getElementById('searchStudent').value.toLowerCase();
            const gradeFilter = document.getElementById('filterGrade').value;
            const statusFilter = document.getElementById('filterStatus').value;
            
            const allStudentsTable = document.getElementById('allStudentsTable');
            allStudentsTable.innerHTML = '';

            const filteredStudents = allStudentsData.filter(data => {
                // Search filter
                const searchMatch = !searchTerm || 
                    data.studentId?.toLowerCase().includes(searchTerm) ||
                    `${data.firstName} ${data.lastName}`.toLowerCase().includes(searchTerm) ||
                    data.phone?.toLowerCase().includes(searchTerm) ||
                    data.nickname?.toLowerCase().includes(searchTerm);

                // Grade filter
                const gradeMatch = !gradeFilter || data.grade === gradeFilter;

                // Status filter
                const isApplicant = applicantIds.has(data.studentId);
                const statusMatch = !statusFilter || 
                    (statusFilter === 'applied' && isApplicant) ||
                    (statusFilter === 'not-applied' && !isApplicant);

                return searchMatch && gradeMatch && statusMatch;
            });

            filteredStudents.forEach(data => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50';
                const isApplicant = applicantIds.has(data.studentId);
                row.innerHTML = `
                    <td class="py-3 px-2">${data.studentId}</td>
                    <td class="py-3 px-2">${data.prefix} ${data.firstName} ${data.lastName}</td>
                    <td class="py-3 px-2">${data.grade}/${data.room}</td>
                    <td class="py-3 px-2">${data.phone}</td>
                    <td class="py-3 px-2">
                        <span class="px-2 py-1 rounded-full text-xs text-white ${isApplicant ? 'bg-green-500' : 'bg-gray-500'}">
                            ${isApplicant ? '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£'}
                        </span>
                    </td>
                    <td class="py-3 px-2">
                        <button onclick="editStudent('${data.docId}', ${JSON.stringify(data).replace(/"/g, '&quot;')})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors mr-2">
                            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                        <button onclick="deleteStudent('${data.docId}', '${data.studentId}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                            ‡∏•‡∏ö
                        </button>
                    </td>
                `;
                allStudentsTable.appendChild(row);
            });

            // Show count
            const totalCount = allStudentsData.length;
            const filteredCount = filteredStudents.length;
            
            // MODIFICATION: Update Student Count Title
            const totalStudentsCountElement = document.getElementById('totalStudentsCount');
            if (totalStudentsCountElement) {
                if (totalCount !== filteredCount) {
                    totalStudentsCountElement.textContent = `(${filteredCount} ‡∏à‡∏≤‡∏Å ${totalCount} ‡∏Ñ‡∏ô)`;
                } else {
                    totalStudentsCountElement.textContent = `(${totalCount} ‡∏Ñ‡∏ô)`;
                }
            }
            // END MODIFICATION
            
            if (totalCount !== filteredCount) {
                const countInfo = document.createElement('tr');
                countInfo.innerHTML = `
                    <td colspan="6" class="py-2 px-2 text-center text-gray-600 bg-blue-50">
                        ‡πÅ‡∏™‡∏î‡∏á ${filteredCount} ‡∏à‡∏≤‡∏Å ${totalCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    </td>
                `;
                allStudentsTable.appendChild(countInfo);
            }
        }

        // Registration toggle
        document.getElementById('registrationToggle').addEventListener('change', async (e) => {
            try {
                await db.collection('settings').doc('registration').set({
                    isOpen: e.target.checked
                }, { merge: true });
                
                showNotification(e.target.checked ? '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß' : '‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (error) {
                console.error('Error updating registration status:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', 'error');
            }
        });

        // Set schedule
        document.getElementById('setScheduleBtn').addEventListener('click', async () => {
            const openDateTime = document.getElementById('openDateTime').value;
            const closeDateTime = document.getElementById('closeDateTime').value;

            if (!openDateTime || !closeDateTime) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }

            try {
                await db.collection('settings').doc('registration').set({
                    openDateTime: new Date(openDateTime),
                    closeDateTime: new Date(closeDateTime),
                    autoSchedule: true
                }, { merge: true });

                showNotification('‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (error) {
                console.error('Error setting schedule:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤', 'error');
            }
        });

        // Clear schedule
        document.getElementById('clearScheduleBtn').addEventListener('click', async () => {
            showConfirmation(
                '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡πÅ‡∏ö‡∏ö‡πÅ‡∏°‡∏ô‡∏ô‡∏ß‡∏•‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô',
                async () => {
                    showLoading();
                    try {
                        await db.collection('settings').doc('registration').update({
                            openDateTime: firebase.firestore.FieldValue.delete(),
                            closeDateTime: firebase.firestore.FieldValue.delete(),
                            autoSchedule: false
                        });

                        // Clear the datetime inputs
                        document.getElementById('openDateTime').value = '';
                        document.getElementById('closeDateTime').value = '';

                        hideLoading();
                        showNotification('‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    } catch (error) {
                        console.error('Clear schedule error:', error);
                        hideLoading();
                        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤', 'error');
                    }
                }
            );
        });

        // CSV Import
        document.getElementById('csvImportBtn').addEventListener('click', () => {
            document.getElementById('csvFileInput').click();
        });

        // Clear all students
        document.getElementById('clearStudentsBtn').addEventListener('click', () => {
            showConfirmation(
                '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ',
                async () => {
                    showLoading();
                    try {
                        // Get all students
                        const studentsSnapshot = await db.collection('applications').get();
                        const batch = db.batch();
                        
                        studentsSnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        // Also clear all applicants
                        const applicantsSnapshot = await db.collection('applicants').get();
                        applicantsSnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        await batch.commit();
                        hideLoading();
                        showNotification('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        await loadAdminData();
                    } catch (error) {
                        console.error('Clear students error:', error);
                        hideLoading();
                        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                    }
                }
            );
        });

        document.getElementById('csvFileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            showLoading();
            try {
                const text = await file.text();
                const lines = text.split('\n');
                const batch = db.batch();

                for (let i = 1; i < lines.length; i++) { // Skip header
                    const line = lines[i].trim();
                    if (!line) continue;

                    const [studentId, grade, room, prefix, firstName, lastName, nickname, phone] = line.split(',');
                    
                    if (studentId) {
                        // Note: The original code in `index (7).html` used 'students' collection here, 
                        // but the other parts (login, admin load) use 'applications'. 
                        // Assuming 'applications' is the correct collection based on usage.
                        const docRef = db.collection('applications').doc(); 
                        batch.set(docRef, {
                            studentId: studentId.trim(),
                            grade: grade?.trim() || '',
                            room: room?.trim() || '',
                            prefix: prefix?.trim() || '',
                            firstName: firstName?.trim() || '',
                            lastName: lastName?.trim() || '',
                            nickname: nickname?.trim() || '',
                            phone: phone?.trim() || '',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }

                await batch.commit();
                hideLoading();
                showNotification('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                await loadAdminData();
            } catch (error) {
                console.error('CSV import error:', error);
                hideLoading();
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        });

        // CSV Export
        document.getElementById('exportBtn').addEventListener('click', async () => {
            try {
                const applicantsSnapshot = await db.collection('applicants').orderBy('timestamp', 'desc').get();
                
                let csv = '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏ä‡∏±‡πâ‡∏ô,‡∏´‡πâ‡∏≠‡∏á,‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤,‡∏ä‡∏∑‡πà‡∏≠,‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•,‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô,‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå,‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£\n';
                
                applicantsSnapshot.forEach(doc => {
                    const data = doc.data();
                    csv += `${data.studentId},${data.grade},${data.room},${data.prefix},${data.firstName},${data.lastName},${data.nickname},${data.phone},${data.timestamp?.toDate().toLocaleString('th-TH') || 'N/A'}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `SPT-SMLC-REGIS-APPLICATIONS_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();

                showNotification('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                if (isAdmin) {
                    await auth.signOut();
                }
                
                currentUser = null;
                isAdmin = false;
                
                loginPage.classList.remove('hidden');
                studentDashboard.classList.add('hidden');
                adminDashboard.classList.add('hidden');
                document.getElementById('logoutBtn').classList.add('hidden');
                
                // Reset forms
                document.getElementById('studentId').value = '';
                document.getElementById('phoneNumber').value = '';
                document.getElementById('adminEmail').value = '';
                document.getElementById('adminPassword').value = '';
                
                showNotification('‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö', 'error');
            }
        });

        // Edit student function
        function editStudent(docId, studentData) {
            document.getElementById('editStudentDocId').value = docId;
            document.getElementById('editStudentId').value = studentData.studentId || '';
            document.getElementById('editGrade').value = studentData.grade || '';
            document.getElementById('editRoom').value = studentData.room || '';
            document.getElementById('editPrefix').value = studentData.prefix || '‡∏ô‡∏≤‡∏¢';
            document.getElementById('editFirstName').value = studentData.firstName || '';
            document.getElementById('editLastName').value = studentData.lastName || '';
            document.getElementById('editNickname').value = studentData.nickname || '';
            document.getElementById('editPhone').value = studentData.phone || '';
            
            document.getElementById('editStudentModal').classList.remove('hidden');
        }

        // Delete student function
        function deleteStudent(docId, studentId) {
            showConfirmation(
                `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™ ${studentId} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                async () => {
                    showLoading();
                    try {
                        await db.collection('applications').doc(docId).delete();
                        hideLoading();
                        showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        await loadAdminData();
                    } catch (error) {
                        console.error('Delete student error:', error);
                        hideLoading();
                        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                    }
                }
            );
        }

        // Cancel application function
        function cancelApplication(docId, studentId) {
            showConfirmation(
                `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™ ${studentId} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                async () => {
                    showLoading();
                    try {
                        await db.collection('applicants').doc(docId).delete();
                        hideLoading();
                        showNotification('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        await loadAdminData();
                    } catch (error) {
                        console.error('Cancel application error:', error);
                        hideLoading();
                        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£', 'error');
                    }
                }
            );
        }

        // Show confirmation modal
        function showConfirmation(message, onConfirm) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').classList.remove('hidden');
            
            const confirmYes = document.getElementById('confirmYes');
            const confirmNo = document.getElementById('confirmNo');
            
            // Remove existing event listeners
            const newConfirmYes = confirmYes.cloneNode(true);
            const newConfirmNo = confirmNo.cloneNode(true);
            confirmYes.parentNode.replaceChild(newConfirmYes, confirmYes);
            confirmNo.parentNode.replaceChild(newConfirmNo, confirmNo);
            
            // Add new event listeners
            newConfirmYes.addEventListener('click', () => {
                document.getElementById('confirmModal').classList.add('hidden');
                onConfirm();
            });
            
            newConfirmNo.addEventListener('click', () => {
                document.getElementById('confirmModal').classList.add('hidden');
            });
        }

        // Edit student form submission
        document.getElementById('editStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const docId = document.getElementById('editStudentDocId').value;
            const updatedData = {
                studentId: document.getElementById('editStudentId').value.trim(),
                grade: document.getElementById('editGrade').value.trim(),
                room: document.getElementById('editRoom').value.trim(),
                prefix: document.getElementById('editPrefix').value,
                firstName: document.getElementById('editFirstName').value.trim(),
                lastName: document.getElementById('editLastName').value.trim(),
                nickname: document.getElementById('editNickname').value.trim(),
                phone: document.getElementById('editPhone').value.trim()
            };

            if (!updatedData.studentId || !updatedData.firstName || !updatedData.lastName) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }

            showLoading();
            try {
                await db.collection('applications').doc(docId).update(updatedData);
                
                // Update applicant data if exists
                const applicantQuery = await db.collection('applicants')
                    .where('studentId', '==', updatedData.studentId)
                    .get();
                
                if (!applicantQuery.empty) {
                    const applicantDoc = applicantQuery.docs[0];
                    await db.collection('applicants').doc(applicantDoc.id).update(updatedData);
                }

                hideLoading();
                document.getElementById('editStudentModal').classList.add('hidden');
                showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                await loadAdminData();
            } catch (error) {
                console.error('Update student error:', error);
                hideLoading();
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        });

        // Cancel edit button
        document.getElementById('cancelEditBtn').addEventListener('click', () => {
            document.getElementById('editStudentModal').classList.add('hidden');
        });

        // MODIFICATION: Cancel my application function (for students) - now checks if registration is open
        function cancelMyApplication(docId) {
            showConfirmation(
                '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ',
                async () => {
                    showLoading();
                    try {
                        const registrationOpen = await isRegistrationCurrentlyOpen();
                        if (!registrationOpen) {
                            hideLoading();
                            showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß', 'error');
                            checkRegistrationStatus(); // Re-check to update status and button state
                            return;
                        }

                        await db.collection('applicants').doc(docId).delete();
                        hideLoading();
                        showNotification('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        checkRegistrationStatus();
                    } catch (error) {
                        console.error('Cancel my application error:', error);
                        hideLoading();
                        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£', 'error');
                    }
                }
            );
        }
        // END MODIFICATION

        // Filter event listeners
        document.getElementById('searchStudent').addEventListener('input', displayFilteredStudents);
        document.getElementById('filterGrade').addEventListener('change', displayFilteredStudents);
        document.getElementById('filterStatus').addEventListener('change', displayFilteredStudents);

        // Clear filters
        document.getElementById('clearFiltersBtn').addEventListener('click', () => {
            document.getElementById('searchStudent').value = '';
            document.getElementById('filterGrade').value = '';
            document.getElementById('filterStatus').value = '';
            displayFilteredStudents();
        });

        // Add student button
        document.getElementById('addStudentBtn').addEventListener('click', () => {
            document.getElementById('addStudentModal').classList.remove('hidden');
        });

        // Cancel add student
        document.getElementById('cancelAddBtn').addEventListener('click', () => {
            document.getElementById('addStudentModal').classList.add('hidden');
            document.getElementById('addStudentForm').reset();
        });

        // Add student form submission
        document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const studentData = {
                studentId: document.getElementById('addStudentId').value.trim(),
                grade: document.getElementById('addGrade').value.trim(),
                room: document.getElementById('addRoom').value.trim(),
                prefix: document.getElementById('addPrefix').value,
                firstName: document.getElementById('addFirstName').value.trim(),
                lastName: document.getElementById('addLastName').value.trim(),
                nickname: document.getElementById('addNickname').value.trim(),
                phone: document.getElementById('addPhone').value.trim(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Check if student ID already exists
            const existingStudent = await db.collection('applications')
                .where('studentId', '==', studentData.studentId)
                .get();

            if (!existingStudent.empty) {
                showNotification('‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'error');
                return;
            }

            showLoading();
            try {
                await db.collection('applications').add(studentData);
                hideLoading();
                document.getElementById('addStudentModal').classList.add('hidden');
                document.getElementById('addStudentForm').reset();
                showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                await loadAdminData();
            } catch (error) {
                console.error('Add student error:', error);
                hideLoading();
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'error');
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Check for auto-schedule
            setInterval(async () => {
                try {
                    const settingsDoc = await db.collection('settings').doc('registration').get();
                    const settings = settingsDoc.data();
                    
                    if (settings?.autoSchedule) {
                        const now = new Date();
                        const openTime = settings.openDateTime?.toDate();
                        const closeTime = settings.closeDateTime?.toDate();
                        
                        if (openTime && closeTime) {
                            const shouldBeOpen = now >= openTime && now <= closeTime;
                            
                            if (settings.isOpen !== shouldBeOpen) {
                                await db.collection('settings').doc('registration').update({
                                    isOpen: shouldBeOpen
                                });
                            }
                        }
                    }
                } catch (error) {
                    console.error('Auto-schedule error:', error);
                }
            }, 60000); // Check every minute
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'992e84c6570a7325',t:'MTc2MTE5NDAzMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
