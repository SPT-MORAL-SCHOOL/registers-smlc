<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPT MORAL SCHOOL - ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏Å‡∏ô‡∏ô‡∏≥‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏° ‡∏™‡∏û‡∏ê.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á */
        .card-bg {
            /* ‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÅ‡∏™‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(8px); /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° */
        }
        /* ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏î‡∏µ‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
        .table-responsive {
            overflow-x: auto;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center justify-center p-4">

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        // 1. **Firebase Initialization**
        const firebaseConfig = {
             apiKey: "AIzaSyDjPKzAY2oyB83jcpXHbBKgK1WZhVmsnHA",
             authDomain: "spt-students.firebaseapp.com",
             projectId: "spt-students",
             storageBucket: "spt-students.firebasestorage.app",
             messagingSenderId: "814089202848",
             appId: "1:814089202848:web:0fa59f182f4feadd702dc5",
             measurementId: "G-MEPRLGW034"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
    </script>

    <div id="app-container" class="w-full max-w-4xl">

        <div id="login-page" class="flex flex-col items-center max-w-md mx-auto">
            <img src="https://img5.pic.in.th/file/secure-sv1/IMG_25650953161d1c1bbdd8.jpeg" alt="Logo" class="w-24 h-24 mb-6 rounded-full shadow-lg">
            <div class="card-bg p-8 w-full rounded-xl shadow-2xl transition duration-300 border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>

                <div class="space-y-4">
                    <div>
                        <label for="studentId" class="block text-sm font-medium text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <input type="text" id="studentId" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    </div>
                    <div>
                        <label for="phoneNumber" class="block text-sm font-medium text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (10 ‡∏´‡∏•‡∏±‡∏Å)</label>
                        <input type="tel" id="phoneNumber" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    </div>
                    <p id="login-error" class="text-red-500 text-sm hidden"></p>
                    <button id="login-button" class="w-full py-3 mt-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-[1.01]">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>

                <a href="#" id="show-admin-login-link" class="mt-4 block text-center text-sm text-gray-500 hover:text-blue-600 transition duration-150">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</a>
            </div>
            
            <div id="admin-login-form" class="card-bg p-6 w-full rounded-xl shadow-2xl mt-4 hidden border border-gray-200">
                <h3 class="text-xl font-semibold mb-4 text-center">Admin Login</h3>
                <input type="email" id="adminEmail" placeholder="Email (sptmorral@spt.ac.th)" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg mb-3">
                <input type="password" id="adminPassword" placeholder="Password" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg mb-3">
                <p id="admin-login-error" class="text-red-500 text-sm hidden mb-3"></p>
                <button id="admin-login-button" class="w-full py-2 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700">Login Admin</button>
            </div>
        </div>

        <div id="student-dashboard" class="hidden max-w-md mx-auto">
            <div class="card-bg p-8 w-full rounded-xl shadow-2xl transition duration-300 border border-gray-200">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö, <span id="studentNameDisplay"></span> üëã</h2>
                <p class="text-gray-600 mb-6">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: <span id="studentIdDisplay" class="font-medium"></span></p>

                <div id="applicationStatus" class="p-4 rounded-lg bg-gray-50 mb-6 text-center">
                    </div>

                <button id="applyButton" class="w-full py-3 mt-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-[1.01]">
                    ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏Å‡∏ô‡∏ô‡∏≥‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏° ‡∏™‡∏û‡∏ê.
                </button>

                <button id="logoutButton" class="w-full py-2 mt-4 text-sm bg-red-400 text-white rounded-lg shadow-md hover:bg-red-500 transition duration-300">
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
        </div>

        <div id="admin-page" class="hidden">
            <div class="card-bg p-6 w-full rounded-xl shadow-2xl border border-gray-200">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">‚öôÔ∏è ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <p class="text-sm text-gray-600 mb-6">‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•: sptmorral@spt.ac.th</p>

                <div class="flex justify-between items-center mb-4">
                    <button id="exportCsvButton" class="py-2 px-4 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition duration-300">
                        ‚¨áÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV
                    </button>
                    <button id="adminLogoutButton" class="py-2 px-4 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-300">
                        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>

                <h3 class="text-xl font-semibold mb-3">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                <div class="table-responsive">
                    <table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™ ‡∏ô‡∏£.</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏Å‡∏ô‡∏ô‡∏≥</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
                            </tr>
                        </thead>
                        <tbody id="applicantTableBody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
        
    </div>

    <footer class="mt-8 text-center text-sm text-gray-500 w-full">
        <div class="card-bg p-3 rounded-lg border border-gray-200 max-w-md mx-auto">
            &copy 2024 SPT MORAL SCHOOL - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏° ‡∏™‡∏û‡∏ê. ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á | All Rights Reserved
        </div>
    </footer>

    <script>

        // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        let currentUserData = null;

        // ** A. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Dashboard ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô **
        const loadStudentDashboard = (userData) => {
            document.getElementById('studentNameDisplay').textContent = userData.name || '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
            document.getElementById('studentIdDisplay').textContent = userData.studentId;
            
            const applicationStatus = document.getElementById('applicationStatus');
            const applyButton = document.getElementById('applyButton');
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£
            if (userData.isMoralLeader === true) {
                applicationStatus.innerHTML = '<p class="text-lg text-green-600 font-bold">‚úÖ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏Å‡∏ô‡∏ô‡∏≥‡πÅ‡∏•‡πâ‡∏ß</p>';
                applyButton.classList.add('hidden');
            } else {
                applicationStatus.innerHTML = '<p class="text-lg text-red-500 font-bold">‚ùå ‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏Å‡∏ô‡∏ô‡∏≥</p>';
                applyButton.classList.remove('hidden');
            }
        };

        // ** B. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Dashboard Admin **

        const renderAdminTable = (applicants) => {
            const tbody = document.getElementById('applicantTableBody');
            tbody.innerHTML = ''; // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤
            
            applicants.forEach(app => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                
                const statusBadge = app.isMoralLeader
                    ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß</span>'
                    : '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</span>';

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${app.studentId || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${app.name || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${app.phoneNumber || '-'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center">${statusBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                        <button onclick="editApplicant('${app.id}', '${app.studentId}')" class="text-indigo-600 hover:text-indigo-900 mr-3">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button onclick="deleteApplicant('${app.id}', '${app.studentId}')" class="text-red-600 hover:text-red-900">‡∏•‡∏ö</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        };

        const loadAdminDashboard = async () => {
            try {
                const applicationsRef = db.collection('applications');
                const snapshot = await applicationsRef.get();
                const applicants = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminTable(applicants);
                return applicants; // ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö CSV
            } catch (error) {
                console.error("Error loading admin data:", error);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö");
                return [];
            }
        };

        // ** C. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô CRUD/Export ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin **

        const editApplicant = async (docId, studentId) => {
            const newPhone = prompt(`‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${studentId}:`);
            if (newPhone) {
                try {
                    await db.collection('applications').doc(docId).update({
                        phoneNumber: newPhone.trim()
                        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                    });
                    alert(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${studentId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                    await loadAdminDashboard(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                } catch (error) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
                }
            }
        };

        const deleteApplicant = async (docId, studentId) => {
            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${studentId} ‡∏ô‡∏µ‡πâ?`)) {
                try {
                    await db.collection('applications').doc(docId).delete();
                    alert(`‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${studentId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                    await loadAdminDashboard(); // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà
                } catch (error) {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
                }
            }
        };

        const exportCSV = (data) => {
            const csvRows = [];
            
            // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ç‡∏≠‡∏á Headers ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            const headers = ['id', 'studentId', 'name', 'phoneNumber', 'isMoralLeader', 'applicationDate'];
            csvRows.push(headers.join(','));

            for (const row of data) {
                const values = headers.map(header => {
                    let value = row[header] === undefined || row[header] === null ? '' : row[header];
                    
                    if (header === 'applicationDate' && value.toDate) {
                        value = value.toDate().toLocaleString('th-TH'); // ‡πÅ‡∏õ‡∏•‡∏á Firestore Timestamp ‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ
                    }
                    if (header === 'isMoralLeader') {
                        value = value ? '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£';
                    }

                    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏≥‡∏û‡∏π‡∏î‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    const escaped = ('' + value).replace(/"/g, '\\"');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }

            const csvString = '\ufeff' + csvRows.join('\n'); // \ufeff ‡πÄ‡∏û‡∏¥‡πà‡∏° BOM ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÉ‡∏ô Excel
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'spt_moral_applicants_' + new Date().toISOString().slice(0, 10) + '.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // ** D. ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ **

        const showPage = (pageId) => {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('student-dashboard').classList.add('hidden');
            document.getElementById('admin-page').classList.add('hidden');
            document.getElementById(pageId).classList.remove('hidden');
        };

        const checkAuthStatus = () => {
            const user = localStorage.getItem('loggedInUser');
            auth.onAuthStateChanged((adminUser) => {
                if (adminUser && adminUser.email === 'sptmorral@spt.ac.th') {
                    // ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà
                    showPage('admin-page');
                    loadAdminDashboard();
                } else if (user) {
                    // ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà
                    currentUserData = JSON.parse(user);
                    showPage('student-dashboard');
                    loadStudentDashboard(currentUserData);
                } else {
                    // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô
                    showPage('login-page');
                }
            });
        };

        // ** E. Event Listeners **

        // 1. Student Login
        document.getElementById('login-button').addEventListener('click', async () => {
            const studentId = document.getElementById('studentId').value.trim();
            const phoneNumber = document.getElementById('phoneNumber').value.trim();
            const errorElement = document.getElementById('login-error');
            errorElement.classList.add('hidden');

            if (!studentId || !phoneNumber) {
                errorElement.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô';
                errorElement.classList.remove('hidden');
                return;
            }

            try {
                const snapshot = await db.collection('applications')
                    .where('studentId', '==', studentId)
                    .where('phoneNumber', '==', phoneNumber)
                    .limit(1)
                    .get();

                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    currentUserData = { ...doc.data(), id: doc.id };
                    localStorage.setItem('loggedInUser', JSON.stringify(currentUserData));
                    showPage('student-dashboard');
                    loadStudentDashboard(currentUserData);
                } else {
                    errorElement.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                    errorElement.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Student Login Error:", error);
                errorElement.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: ' + error.message;
                errorElement.classList.remove('hidden');
            }
        });

        // 2. Student Apply Button
        document.getElementById('applyButton').addEventListener('click', async () => {
            if (!currentUserData || currentUserData.isMoralLeader) return;

            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏Å‡∏ô‡∏ô‡∏≥‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏° ‡∏™‡∏û‡∏ê. ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                try {
                    const userDocRef = db.collection('applications').doc(currentUserData.id);
                    await userDocRef.update({
                        isMoralLeader: true,
                        applicationDate: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô UI/Local Storage
                    currentUserData.isMoralLeader = true;
                    currentUserData.applicationDate = new Date(); // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                    localStorage.setItem('loggedInUser', JSON.stringify(currentUserData));
                    loadStudentDashboard(currentUserData);
                    alert('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏Ç‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏¥‡∏ô‡∏î‡∏µ');
                } catch (error) {
                    console.error("Application Error:", error);
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ' + error.message);
                }
            }
        });

        // 3. Student Logout
        document.getElementById('logoutButton').addEventListener('click', () => {
            localStorage.removeItem('loggedInUser');
            currentUserData = null;
            showPage('login-page');
        });

        // 4. Admin Login Toggle
        document.getElementById('show-admin-login-link').addEventListener('click', (e) => {
            e.preventDefault();
            const adminForm = document.getElementById('admin-login-form');
            adminForm.classList.toggle('hidden');
        });

        // 5. Admin Login Submit
        document.getElementById('admin-login-button').addEventListener('click', async () => {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            const errorElement = document.getElementById('admin-login-error');
            errorElement.classList.add('hidden');

            if (email !== 'sptmorral@spt.ac.th') {
                 errorElement.textContent = '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                 errorElement.classList.remove('hidden');
                 return;
            }

            try {
                await auth.signInWithEmailAndPassword(email, password);
                // AuthStateChange ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            } catch (error) {
                console.error("Admin Login Error:", error);
                errorElement.textContent = '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á: ' + error.message;
                errorElement.classList.remove('hidden');
            }
        });

        // 6. Admin Logout
        document.getElementById('adminLogoutButton').addEventListener('click', () => {
            auth.signOut().then(() => {
                showPage('login-page');
                localStorage.removeItem('loggedInUser'); // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡πà‡∏≠‡∏ô
            });
        });

        // 7. Export CSV
        document.getElementById('exportCsvButton').addEventListener('click', async () => {
            const applicants = await loadAdminDashboard();
            if (applicants.length > 0) {
                exportCSV(applicants);
            } else {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
            }
        });

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        checkAuthStatus();
    </script>
</body>
</html>
