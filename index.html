<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏° ‚Ä¢ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Prompt', 'Kanit', sans-serif;
            background: #ffffff;
            min-height: 100%;
            font-weight: 400;
        }
        html, body {
            height: 100%;
        }
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }
        .btn-register {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            font-weight: 700;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-register:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 20px 40px rgba(255, 107, 107, 0.4);
        }
        .btn-cancel {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .btn-cancel:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(231, 76, 60, 0.3);
        }
        .fade-in {
            animation: fadeIn 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        .status-success { background: linear-gradient(135deg, #00b894 0%, #00a085 100%); color: white; border: none; }
        .status-error { background: linear-gradient(135deg, #e17055 0%, #d63031 100%); color: white; border: none; }
        .status-info { background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); color: white; border: none; }
    </style>
</head>
<body class="min-h-full">
    <div id="app" class="min-h-full flex flex-col">
        <header class="glass border-b border-white/20 p-4">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <img src="https://img5.pic.in.th/file/secure-sv1/IMG_25650953161d1c1bbdd8.jpeg" 
                         alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="w-12 h-12 rounded-full object-cover">
                    <div>
                        <h1 class="text-gray-800 font-bold text-lg md:text-xl">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
                        <p class="text-gray-600 text-sm">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏° ‡∏™‡∏û‡∏ê. ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á</p>
                    </div>
                </div>
                <button id="logoutBtn" class="hidden bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
        </header>

        <main class="flex-1 p-4">
            <div class="max-w-6xl mx-auto">
                <div id="loginPage" class="fade-in">
                    <div class="max-w-md mx-auto glass rounded-2xl p-8 shadow-2xl">
                        <div class="text-center mb-8">
                            <img src="https://img5.pic.in.th/file/secure-sv1/IMG_25650953161d1c1bbdd8.jpeg" 
                                 alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="w-20 h-20 rounded-full mx-auto mb-4 object-cover">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                            <p class="text-gray-600">Student Morality Leadership Committee</p>
                        </div>

                        <div id="studentLogin" class="space-y-6">
                            <div>
                                <label for="studentId" class="block text-gray-700 font-medium mb-2">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                                <input type="text" id="studentId" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
                            </div>
                            <div>
                                <label for="phoneNumber" class="block text-gray-700 font-medium mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                                <input type="tel" id="phoneNumber" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
                            </div>
                            <button id="studentLoginBtn" class="w-full btn-primary text-white font-bold py-3 px-6 rounded-xl">
                                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                            </button>
                        </div>

                        <div class="my-6 text-center">
                            <span class="text-gray-500">‡∏´‡∏£‡∏∑‡∏≠</span>
                        </div>

                        <button id="adminToggle" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-6 rounded-xl transition-colors border border-gray-300">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•
                        </button>

                        <div id="adminLogin" class="hidden space-y-6 mt-6">
                            <div>
                                <label for="adminEmail" class="block text-gray-700 font-medium mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</label>
                                <input type="email" id="adminEmail" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•">
                            </div>
                            <div>
                                <label for="adminPassword" class="block text-gray-700 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                                <input type="password" id="adminPassword" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                            </div>
                            <button id="adminLoginBtn" class="w-full btn-primary text-white font-bold py-3 px-6 rounded-xl">
                                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•
                            </button>
                        </div>
                    </div>
                </div>

                <div id="studentDashboard" class="hidden fade-in">
                    <div class="max-w-2xl mx-auto glass rounded-2xl p-8 shadow-2xl">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                            <div id="studentInfo" class="bg-blue-50 border border-blue-200 rounded-xl p-6 text-gray-800">
                                </div>
                        </div>

                        <div class="text-center">
                            <div id="countdownTimer" class="mb-6 hidden">
                                </div>
                            <div id="registrationStatus" class="mb-6"></div>
                            
                            <button id="registerBtn" class="btn-register text-white font-bold py-5 px-10 rounded-2xl text-xl shadow-2xl hidden">
                                üéØ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏°
                            </button>
                        </div>
                    </div>
                </div>

                <div id="adminDashboard" class="hidden fade-in space-y-6">
                    <div class="glass rounded-2xl p-6 shadow-2xl">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</h2>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-700 font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£ (Master Switch)</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="registrationToggle" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                    </label>
                                </div>

                                <div class="border-t border-gray-200 my-4 pt-4">
                                    <label class="block text-gray-700 font-medium mb-3">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
                                    <div class="grid grid-cols-3 gap-2 mb-3">
                                        <label class="inline-flex items-center bg-gray-50 p-2 rounded-lg cursor-pointer hover:bg-gray-100">
                                            <input type="checkbox" class="grade-select w-5 h-5 text-blue-600 rounded focus:ring-blue-500" value="‡∏°.1">
                                            <span class="ml-2 text-gray-700">‡∏°.1</span>
                                        </label>
                                        <label class="inline-flex items-center bg-gray-50 p-2 rounded-lg cursor-pointer hover:bg-gray-100">
                                            <input type="checkbox" class="grade-select w-5 h-5 text-blue-600 rounded focus:ring-blue-500" value="‡∏°.2">
                                            <span class="ml-2 text-gray-700">‡∏°.2</span>
                                        </label>
                                        <label class="inline-flex items-center bg-gray-50 p-2 rounded-lg cursor-pointer hover:bg-gray-100">
                                            <input type="checkbox" class="grade-select w-5 h-5 text-blue-600 rounded focus:ring-blue-500" value="‡∏°.3">
                                            <span class="ml-2 text-gray-700">‡∏°.3</span>
                                        </label>
                                        <label class="inline-flex items-center bg-gray-50 p-2 rounded-lg cursor-pointer hover:bg-gray-100">
                                            <input type="checkbox" class="grade-select w-5 h-5 text-blue-600 rounded focus:ring-blue-500" value="‡∏°.4">
                                            <span class="ml-2 text-gray-700">‡∏°.4</span>
                                        </label>
                                        <label class="inline-flex items-center bg-gray-50 p-2 rounded-lg cursor-pointer hover:bg-gray-100">
                                            <input type="checkbox" class="grade-select w-5 h-5 text-blue-600 rounded focus:ring-blue-500" value="‡∏°.5">
                                            <span class="ml-2 text-gray-700">‡∏°.5</span>
                                        </label>
                                        <label class="inline-flex items-center bg-gray-50 p-2 rounded-lg cursor-pointer hover:bg-gray-100">
                                            <input type="checkbox" class="grade-select w-5 h-5 text-blue-600 rounded focus:ring-blue-500" value="‡∏°.6">
                                            <span class="ml-2 text-gray-700">‡∏°.6</span>
                                        </label>
                                    </div>
                                    <button id="saveGradesBtn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm">
                                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô
                                    </button>
                                </div>

                                <button id="csvImportBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-xl transition-colors">
                                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (CSV)
                                </button>
                                <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                                <button id="addStudentBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-4 rounded-xl transition-colors">
                                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
                                </button>
                                <button id="clearStudentsBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-4 rounded-xl transition-colors">
                                    ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
                                    <input type="datetime-local" id="openDateTime" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
                                    <input type="datetime-local" id="closeDateTime" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <button id="setScheduleBtn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-medium py-3 px-4 rounded-xl transition-colors mb-2">
                                    ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                                </button>
                                <button id="clearScheduleBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-4 rounded-xl transition-colors">
                                    ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="glass rounded-2xl p-6 shadow-2xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£ <span id="applicantCount" class="text-base font-normal text-gray-500">(0 ‡∏Ñ‡∏ô)</span></h3>
                            <button id="exportApplicantsBtn" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-gray-800">
                                <thead>
                                    <tr class="border-b border-gray-200 bg-gray-50">
                                        <th class="text-left py-3 px-2 font-semibold">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody id="applicantsTableBody" class="text-gray-600 text-sm font-light">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="glass rounded-2xl p-6 shadow-2xl">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="totalStudentsCount" class="text-base font-normal text-gray-500">(0 ‡∏Ñ‡∏ô)</span></h3>
                        
                        <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
                                <input type="text" id="searchStudent" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏´‡∏±‡∏™, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏±‡πâ‡∏ô</label>
                                <select id="filterGrade" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
                                <select id="filterStatus" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                    <option value="applied">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß</option>
                                    <option value="not_applied">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button id="searchBtn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                    ‡πÅ‡∏™‡∏î‡∏á/‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-gray-800">
                                <thead>
                                    <tr class="border-b border-gray-200 bg-gray-50">
                                        <th class="text-left py-3 px-2 font-semibold">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody id="allStudentsTable" class="text-gray-600 text-sm font-light">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    </div>
            </div>
        </main>

        <footer class="glass border-t border-gray-200 p-4 mt-8">
            <div class="max-w-6xl mx-auto text-center text-gray-600 text-sm">
                &copy; 2024 SPT MORAL SCHOOL - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏° ‡∏™‡∏û‡∏ê. ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á | All Rights Reserved
            </div>
        </footer>

        <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="glass rounded-2xl p-8 text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <p class="text-gray-800 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            </div>
        </div>

        <div id="addStudentModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="glass rounded-2xl p-8 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-6">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                <form id="addStudentForm" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <input type="text" id="addStudentId" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏±‡πâ‡∏ô</label>
                            <select id="addGrade" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="‡∏°.1">‡∏°.1</option>
                                <option value="‡∏°.2">‡∏°.2</option>
                                <option value="‡∏°.3">‡∏°.3</option>
                                <option value="‡∏°.4">‡∏°.4</option>
                                <option value="‡∏°.5">‡∏°.5</option>
                                <option value="‡∏°.6">‡∏°.6</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡∏´‡πâ‡∏≠‡∏á</label>
                            <input type="text" id="addRoom" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                        <select id="addPrefix" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢">‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢</option>
                            <option value="‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á">‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á</option>
                            <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                            <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠</label>
                        <input type="text" id="addFirstName" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="addLastName" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö)</label>
                        <input type="tel" id="addPhone" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="pt-4 flex justify-end space-x-3">
                        <button type="submit" class="btn-primary text-white font-medium py-2 px-4 rounded-xl">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                        <button type="button" id="closeAddStudentModal" class="btn-cancel text-white font-medium py-2 px-4 rounded-xl">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="editStudentModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="glass rounded-2xl p-8 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-6">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                <form id="editStudentForm" class="space-y-4">
                    <input type="hidden" id="editStudentDocId">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <input type="text" id="editStudentId" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" readonly>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏±‡πâ‡∏ô</label>
                            <input type="text" id="editGrade" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡∏´‡πâ‡∏≠‡∏á</label>
                            <input type="text" id="editRoom" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                        <select id="editPrefix" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢">‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢</option>
                            <option value="‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á">‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á</option>
                            <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                            <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠</label>
                        <input type="text" id="editFirstName" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="editLastName" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                        <input type="tel" id="editPhone" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="pt-4 flex justify-end space-x-3">
                        <button type="submit" class="btn-primary text-white font-medium py-2 px-4 rounded-xl">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                        <button type="button" id="closeEditStudentModal" class="btn-cancel text-white font-medium py-2 px-4 rounded-xl">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="confirmModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="glass rounded-2xl p-8 max-w-sm w-full mx-4 text-center">
                <h3 class="text-xl font-bold text-gray-800 mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
                <p id="confirmMessage" class="text-gray-700 mb-6">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                <div class="flex justify-center space-x-4">
                    <button id="confirmYes" class="btn-primary text-white font-medium py-2 px-4 rounded-xl min-w-[100px]">‡πÉ‡∏ä‡πà</button>
                    <button id="confirmNo" class="btn-cancel text-white font-medium py-2 px-4 rounded-xl min-w-[100px]">‡πÑ‡∏°‡πà</button>
                </div>
            </div>
        </div>
        </div>

    <script>
        // Firebase Config (Replace with your actual config)
        const firebaseConfig = {
          apiKey: "AIzaSyDjPKzAY2oyB83jcpXHbBKgK1WZhVmsnHA",
          authDomain: "spt-students.firebaseapp.com",
          projectId: "spt-students",
          storageBucket: "spt-students.firebasestorage.app",
          messagingSenderId: "814089202848",
          appId: "1:814089202848:web:0fa59f182f4feadd702dc5",
          measurementId: "G-MEPRLGW034"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        let currentUser = null;
        let isAdmin = false;
        let registrationOpen = true;
        let countdownInterval = null;
        let allStudentsData = []; // Cache all student data for filtering
        const applicantIds = new Set(); // Cache studentIds of applicants
        let adminListeners = []; // To store listeners to unsubscribe on logout

        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const studentDashboard = document.getElementById('studentDashboard');
        const adminDashboard = document.getElementById('adminDashboard');
        const logoutBtn = document.getElementById('logoutBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const registrationStatus = document.getElementById('registrationStatus');
        const registerBtn = document.getElementById('registerBtn');
        const countdownTimer = document.getElementById('countdownTimer');
        const registrationToggle = document.getElementById('registrationToggle');

        // Utility Functions
        function showLoading() { loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { loadingOverlay.classList.add('hidden'); }
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 fade-in shadow-lg ${
                type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.innerHTML = message;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        let confirmCallback = null;
        function showConfirmation(message, callback) {
            confirmCallback = callback;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').classList.remove('hidden');
        }

        // --- UI STATE MANAGEMENT --- //
        function showStudentDashboard() {
            loginPage.classList.add('hidden');
            adminDashboard.classList.add('hidden');
            studentDashboard.classList.remove('hidden');
            logoutBtn.classList.remove('hidden');
            isAdmin = false;
        }

        function showAdminDashboard() {
            loginPage.classList.add('hidden');
            studentDashboard.classList.add('hidden');
            adminDashboard.classList.remove('hidden');
            logoutBtn.classList.remove('hidden');
            isAdmin = true;
            loadAdminData();
        }

        function showLoginPage() {
            studentDashboard.classList.add('hidden');
            adminDashboard.classList.add('hidden');
            loginPage.classList.remove('hidden');
            logoutBtn.classList.add('hidden');
            currentUser = null;
            isAdmin = false;
            if (countdownInterval) clearInterval(countdownInterval);
            adminListeners.forEach(unsub => unsub()); // Unsubscribe Admin Listeners
            adminListeners = [];
        }

        function updateCountdown(targetDate, isOpening) {
            countdownTimer.classList.remove('hidden');
            if (countdownInterval) clearInterval(countdownInterval);

            const updateTimer = () => {
                const now = new Date().getTime();
                const distance = targetDate.getTime() - now;

                if (distance < 0) {
                    clearInterval(countdownInterval);
                    countdownTimer.classList.add('hidden');
                    checkRegistrationStatus(); // Re-check status
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                const bgColor = isOpening ? 'bg-blue-500' : 'bg-orange-500';
                const title = isOpening ? '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ô' : '‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏µ‡∏Å';

                countdownTimer.innerHTML = `
                    <div class="${bgColor} text-white rounded-2xl p-6 shadow-xl">
                        <h3 class="font-bold text-xl mb-3">${title}</h3>
                        <div class="grid grid-cols-4 gap-4 text-center">
                            <div><span class="text-3xl font-bold">${days}</span><br><span class="text-xs">‡∏ß‡∏±‡∏ô</span></div>
                            <div><span class="text-3xl font-bold">${hours}</span><br><span class="text-xs">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span></div>
                            <div><span class="text-3xl font-bold">${minutes}</span><br><span class="text-xs">‡∏ô‡∏≤‡∏ó‡∏µ</span></div>
                            <div><span class="text-3xl font-bold">${seconds}</span><br><span class="text-xs">‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</span></div>
                        </div>
                    </div>
                `;
            };

            updateTimer();
            countdownInterval = setInterval(updateTimer, 1000);
        }

        // --- AUTHENTICATION --- //

        // Toggle Student/Admin Login
        document.getElementById('adminToggle').addEventListener('click', () => {
            const studentLogin = document.getElementById('studentLogin');
            const adminLogin = document.getElementById('adminLogin');
            const btn = document.getElementById('adminToggle');
            if (adminLogin.classList.contains('hidden')) {
                studentLogin.classList.add('hidden');
                adminLogin.classList.remove('hidden');
                btn.textContent = '‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
            } else {
                studentLogin.classList.remove('hidden');
                adminLogin.classList.add('hidden');
                btn.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•';
            }
        });

        // Student Login
        document.getElementById('studentLoginBtn').addEventListener('click', async () => {
            const studentId = document.getElementById('studentId').value.trim();
            const phoneNumber = document.getElementById('phoneNumber').value.trim();

            if (!studentId || !phoneNumber) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }

            showLoading();
            try {
                const studentQuery = await db.collection('applications')
                    .where('studentId', '==', studentId)
                    .where('phone', '==', phoneNumber)
                    .get();

                if (studentQuery.empty) {
                    showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                    hideLoading();
                    return;
                }

                // Student found
                currentUser = { ...studentQuery.docs[0].data(), docId: studentQuery.docs[0].id };
                document.getElementById('studentInfo').innerHTML = `
                    <p class="text-2xl font-bold">${currentUser.prefix} ${currentUser.firstName} ${currentUser.lastName}</p>
                    <p class="text-lg mt-1">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${currentUser.studentId} | ‡∏ä‡∏±‡πâ‡∏ô: ${currentUser.grade}/${currentUser.room}</p>
                    <p class="text-md mt-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå: ${currentUser.phone}</p>
                `;

                showStudentDashboard();
                await checkRegistrationStatus();

            } catch (error) {
                console.error('Student login error:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö', 'error');
            } finally {
                hideLoading();
            }
        });

        // Admin Login (using Firebase Auth)
        document.getElementById('adminLoginBtn').addEventListener('click', async () => {
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value.trim();

            if (!email || !password) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'error');
                return;
            }

            showLoading();
    try {
        // **‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Firebase Authentication**
        await auth.signInWithEmailAndPassword(email, password); 
        
        isAdmin = true; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        showAdminDashboard();
        hideLoading();
        showNotification('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    } catch (error) {
        console.error('Admin login error:', error);
        showNotification('‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        hideLoading();
    }
});

        // Logout
        logoutBtn.addEventListener('click', showLoginPage);


        // --- STUDENT REGISTRATION LOGIC --- //

        async function checkRegistrationStatus() {
            registrationStatus.innerHTML = '';
            registerBtn.classList.add('hidden');
            countdownTimer.classList.add('hidden');
            if (countdownInterval) clearInterval(countdownInterval);

            if (!currentUser) return;

            // 1. Check if student has already applied
            const applicantQuery = await db.collection('applicants').where('studentId', '==', currentUser.studentId).get();

            if (!applicantQuery.empty) {
                const applicantDocId = applicantQuery.docs[0].id;
                registrationStatus.innerHTML = `
                    <div class="status-success rounded-2xl p-6 shadow-xl">
                        <h3 class="font-bold text-xl mb-3">‚úÖ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</h3>
                        <p class="text-lg mb-2">‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß</p>
                        <p class="text-sm opacity-90 mt-3">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ${applicantQuery.docs[0].data().timestamp?.toDate().toLocaleString('th-TH')}</p>
                        <button onclick="cancelMyApplication('${applicantDocId}')" class="mt-5 btn-cancel text-white font-semibold py-3 px-6 rounded-xl transition-all"> üö´ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£ </button>
                    </div>
                `;
                registerBtn.classList.add('hidden');
                countdownTimer.classList.add('hidden');
                if (countdownInterval) clearInterval(countdownInterval);
                return;
            }

            // 2. Get Settings (Master Switch, Grades, Time)
            const settingsDoc = await db.collection('settings').doc('registration').get();
            const settings = settingsDoc.data() || { isOpen: true, allowedGrades: [] };

            // Logic for Time & Countdown
            const now = new Date();
            let isOpening = false;
            let targetDate = null;
            let hasSchedule = false;

            if (settings.openDateTime && settings.closeDateTime) {
                const openTime = settings.openDateTime.toDate();
                const closeTime = settings.closeDateTime.toDate();
                hasSchedule = true;

                if (now < openTime) {
                    // Before opening - show countdown to opening
                    isOpening = true;
                    targetDate = openTime;
                    registrationStatus.innerHTML = `
                        <div class="status-info rounded-2xl p-6 shadow-xl">
                            <h3 class="font-bold text-xl mb-3">‚è≥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å...</h3>
                            <p class="text-sm opacity-90">‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£: ${openTime.toLocaleString('th-TH')} ‡∏ñ‡∏∂‡∏á ${closeTime.toLocaleString('th-TH')}</p>
                        </div>
                    `;
                    registerBtn.classList.add('hidden');
                    updateCountdown(targetDate, isOpening);
                    return;
                } else if (now > closeTime) {
                    // After closing time
                    registrationStatus.innerHTML = `
                        <div class="status-error rounded-2xl p-6 shadow-xl">
                            <h3 class="font-bold text-xl mb-3">üö´ ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß!</h3>
                            <p class="text-lg">‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${closeTime.toLocaleString('th-TH')}</p>
                        </div>
                    `;
                    registerBtn.classList.add('hidden');
                    return;
                } else {
                    // During open time - show countdown to closing
                    targetDate = closeTime;
                    registrationStatus.innerHTML = `
                        <p class="text-lg text-red-600 font-bold">‚è±Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å...</p>
                    `;
                    updateCountdown(targetDate, isOpening);
                }
            }

            // 3. Check Master Switch
            if (!settings.isOpen && !hasSchedule) {
                // If master switch is OFF AND there's no active schedule
                 registrationStatus.innerHTML = `
                    <div class="status-info rounded-2xl p-6 shadow-xl">
                        <h3 class="font-bold text-xl mb-3">üò¥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß</h3>
                        <p class="text-lg">‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
                    </div>
                `;
                registerBtn.classList.add('hidden');
                return;
            }

            // 4. Check allowed grades
            const userGrade = currentUser.grade; // e.g., "‡∏°.4"
            const isGradeAllowed = settings.allowedGrades && settings.allowedGrades.includes(userGrade);

            if (!isGradeAllowed || settings.allowedGrades.length === 0) {
                // Blocked by grade
                registrationStatus.innerHTML = `
                    <div class="status-error rounded-2xl p-6 shadow-2xl border-4 border-red-300 transform hover:scale-[1.01] transition duration-300">
                        <h3 class="font-extrabold text-2xl mb-4 flex items-center justify-center space-x-3">
                            <span class="text-3xl">‚õî</span>
                            <span>‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô!</span>
                        </h3>
                        <p class="text-lg text-center mb-2">
                            ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                            <span class="font-bold bg-white/20 px-3 py-1 rounded-lg tracking-wider">${settings.allowedGrades.join(' ‡πÅ‡∏•‡∏∞ ')}</span>
                            ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                        </p>
                        <p class="text-sm opacity-80 text-center mt-4">
                            ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏á‡∏™‡∏±‡∏¢
                        </p>
                    </div>
                `;
                registerBtn.classList.add('hidden');
                return;
            }

            // 5. Open for registration
            registrationStatus.innerHTML = `
                <div class="status-info rounded-2xl p-6 shadow-xl bg-green-500/10 text-green-800 border border-green-300">
                    <h3 class="font-bold text-xl mb-2">üü¢ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß!</h3>
                    <p class="text-md">‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                </div>
            `;
            registerBtn.classList.remove('hidden');
        }

        // Student Registration Action
        document.getElementById('registerBtn').addEventListener('click', () => {
            showConfirmation('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', async () => {
                showLoading();
                try {
                    await db.collection('applicants').add({
                        studentId: currentUser.studentId,
                        prefix: currentUser.prefix,
                        firstName: currentUser.firstName,
                        lastName: currentUser.lastName,
                        grade: currentUser.grade,
                        room: currentUser.room,
                        phone: currentUser.phone,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showNotification('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'success');
                    await checkRegistrationStatus(); // Refresh dashboard status
                } catch (error) {
                    console.error('Registration error:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£', 'error');
                } finally {
                    hideLoading();
                }
            });
        });

        // Student Cancel Application Action
        window.cancelMyApplication = (docId) => {
            showConfirmation('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', async () => {
                showLoading();
                try {
                    await db.collection('applicants').doc(docId).delete();
                    showNotification('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    await checkRegistrationStatus(); // Refresh dashboard status
                } catch (error) {
                    console.error('Cancel application error:', error);
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£', 'error');
                } finally {
                    hideLoading();
                }
            });
        };

        // --- ADMIN DASHBOARD LOGIC --- //

        async function loadAdminData() {
            showLoading();

            // Clear old listeners
            adminListeners.forEach(unsub => unsub());
            adminListeners = [];

            try {
                // Load students
                const studentsSnapshot = await db.collection('applications').get();
                allStudentsData = studentsSnapshot.docs.map(doc => ({ ...doc.data(), docId: doc.id }));

                // Load applicants (realtime)
                const unsubApplicants = db.collection('applicants').orderBy('timestamp', 'desc').onSnapshot(applicantsSnapshot => {
                    // Update applicantIds set and applicants table body
                    applicantIds.clear();
                    applicantsSnapshot.docs.forEach(doc => {
                        applicantIds.add(doc.data().studentId);
                    });

                    // Update Applicants Table
                    const applicantsTableBody = document.getElementById('applicantsTableBody');
                    applicantsTableBody.innerHTML = '';
                    
                    const applicants = allStudentsData.filter(student => applicantIds.has(student.studentId));
                    document.getElementById('applicantCount').textContent = `(${applicants.length} ‡∏Ñ‡∏ô)`;

                    applicants.forEach(data => {
                        const applicantDoc = applicantsSnapshot.docs.find(doc => doc.data().studentId === data.studentId);
                        const timestamp = applicantDoc?.data().timestamp?.toDate().toLocaleString('th-TH') || 'N/A';
                        const applicantDocId = applicantDoc?.id;

                        const row = document.createElement('tr');
                        row.className = 'border-b border-gray-200 hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="py-3 px-2">${data.studentId}</td>
                            <td class="py-3 px-2 font-medium">${data.prefix} ${data.firstName} ${data.lastName}</td>
                            <td class="py-3 px-2">${data.grade}/${data.room}</td>
                            <td class="py-3 px-2">${data.phone}</td>
                            <td class="py-3 px-2 text-xs">${timestamp}</td>
                            <td class="py-3 px-2">
                                <button onclick="cancelApplication('${applicantDocId}', '${data.studentId}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                            </td>
                        `;
                        applicantsTableBody.appendChild(row);
                    });


                    displayFilteredStudents(); // Re-render all students table after applicant data update
                });
                adminListeners.push(unsubApplicants);

                // Load settings
                const settingsDoc = await db.collection('settings').doc('registration').get();
                const settings = settingsDoc.data() || { isOpen: true, allowedGrades: [] };
                
                // Toggle switch
                registrationToggle.checked = settings.isOpen;

                // Grades checkboxes
                document.querySelectorAll('.grade-select').forEach(checkbox => {
                    checkbox.checked = settings.allowedGrades.includes(checkbox.value);
                });

                // Schedule times
                if (settings.openDateTime && settings.closeDateTime) {
                    const openDate = settings.openDateTime.toDate();
                    const closeDate = settings.closeDateTime.toDate();
                    const formatDateTime = (date) => {
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');
                        return `${year}-${month}-${day}T${hours}:${minutes}`;
                    };
                    document.getElementById('openDateTime').value = formatDateTime(openDate);
                    document.getElementById('closeDateTime').value = formatDateTime(closeDate);
                }

                // Load grades for Filter
                const grades = new Set(allStudentsData.map(s => s.grade).filter(g => g));
                const gradeFilter = document.getElementById('filterGrade');
                const currentSelect = gradeFilter.value;
                gradeFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>';
                Array.from(grades).sort().forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g;
                    opt.textContent = g;
                    if (g === currentSelect) opt.selected = true;
                    gradeFilter.appendChild(opt);
                });

                // Initial display of students
                displayFilteredStudents();

            } catch (error) {
                console.error('Load admin data error:', error);
                showNotification('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
            } finally {
                hideLoading();
            }
        }

        function displayFilteredStudents() {
            const searchTerm = document.getElementById('searchStudent').value.toLowerCase();
            const gradeFilter = document.getElementById('filterGrade').value;
            const statusFilter = document.getElementById('filterStatus').value;
            
            // MODIFIED: Use new ID for All Students Table Body
            const tbody = document.getElementById('allStudentsTable'); 
            tbody.innerHTML = '';

            const filtered = allStudentsData.filter(student => {
                const isApplicant = applicantIds.has(student.studentId);
                const matchSearch = (student.studentId?.toLowerCase().includes(searchTerm) || student.firstName?.toLowerCase().includes(searchTerm) || student.lastName?.toLowerCase().includes(searchTerm) || student.phone?.includes(searchTerm));
                const matchGrade = gradeFilter === '' || student.grade === gradeFilter;
                const matchStatus = statusFilter === '' || (statusFilter === 'applied' && isApplicant) || (statusFilter === 'not_applied' && !isApplicant);
                return matchSearch && matchGrade && matchStatus;
            });

            // Sort by grade/room then studentId
            filtered.sort((a, b) => {
                if (a.grade !== b.grade) return a.grade.localeCompare(b.grade);
                if (a.room !== b.room) return (a.room - b.room);
                return a.studentId.localeCompare(b.studentId);
            });

            filtered.forEach(data => {
                const isApplicant = applicantIds.has(data.studentId);
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-2">${data.studentId}</td>
                    <td class="py-3 px-2">${data.prefix} ${data.firstName} ${data.lastName}</td>
                    <td class="py-3 px-2">${data.grade}/${data.room}</td>
                    <td class="py-3 px-2">${data.phone}</td>
                    <td class="py-3 px-2">
                        <span class="px-2 py-1 rounded-full text-xs text-white ${isApplicant ? 'bg-green-500' : 'bg-gray-500'}">
                            ${isApplicant ? '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£'}
                        </span>
                    </td>
                    <td class="py-3 px-2">
                        <button onclick="editStudent('${data.docId}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors mr-2">
                            ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                        </button>
                        <button onclick="deleteStudent('${data.docId}', '${data.studentId}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                            ‡∏•‡∏ö
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Update Student Count Title
            document.getElementById('totalStudentsCount').textContent = `(${filtered.length} ‡∏à‡∏≤‡∏Å ${allStudentsData.length} ‡∏Ñ‡∏ô)`;
        }

        // --- ADMIN ACTIONS --- //

        document.getElementById('searchBtn').addEventListener('click', displayFilteredStudents);
        document.getElementById('searchStudent').addEventListener('input', displayFilteredStudents);
        document.getElementById('filterGrade').addEventListener('change', displayFilteredStudents);
        document.getElementById('filterStatus').addEventListener('change', displayFilteredStudents);
        

        // Master Switch
        registrationToggle.addEventListener('change', async (e) => {
            const isOpen = e.target.checked;
            try {
                await db.collection('settings').doc('registration').update({ isOpen: isOpen, autoSchedule: false });
                showNotification(`‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô: ${isOpen ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}`, 'success');
            } catch (error) {
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', 'error');
                registrationToggle.checked = !isOpen; // Revert UI on error
            }
        });

        // Save Allowed Grades
        document.getElementById('saveGradesBtn').addEventListener('click', async () => {
            showLoading();
            const allowedGrades = Array.from(document.querySelectorAll('.grade-select:checked')).map(cb => cb.value);
            try {
                await db.collection('settings').doc('registration').set({ allowedGrades: allowedGrades }, { merge: true });
                hideLoading();
                showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (error) {
                hideLoading();
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
            }
        });

        // Set Schedule
        document.getElementById('setScheduleBtn').addEventListener('click', async () => {
            const openDateTime = document.getElementById('openDateTime').value;
            const closeDateTime = document.getElementById('closeDateTime').value;

            if (!openDateTime || !closeDateTime) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£', 'error');
                return;
            }

            showLoading();
            try {
                await db.collection('settings').doc('registration').set({
                    openDateTime: new Date(openDateTime),
                    closeDateTime: new Date(closeDateTime),
                    autoSchedule: true
                }, { merge: true });
                hideLoading();
                showNotification('‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (error) {
                hideLoading();
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
            }
        });

        // Clear Schedule
        document.getElementById('clearScheduleBtn').addEventListener('click', () => {
            showConfirmation('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', async () => {
                try {
                    await db.collection('settings').doc('registration').update({
                        openDateTime: firebase.firestore.FieldValue.delete(),
                        closeDateTime: firebase.firestore.FieldValue.delete(),
                        autoSchedule: false
                    });
                    document.getElementById('openDateTime').value = '';
                    document.getElementById('closeDateTime').value = '';
                    showNotification('‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                } catch (error) {
                    showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
                }
            });
        });

        // CSV Import
        document.getElementById('csvImportBtn').addEventListener('click', () => document.getElementById('csvFileInput').click());
        document.getElementById('csvFileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            showLoading();
            try {
                const text = await file.text();
                const lines = text.split('\n');
                const batch = db.batch();
                let count = 0;

                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    const [id, grade, room, prefix, first, last, nick, phone] = line.split(',');

                    if (id) {
                        const docRef = db.collection('applications').doc(); // Create new document ID
                        batch.set(docRef, {
                            studentId: id.trim(),
                            grade: grade?.trim() || '',
                            room: room?.trim() || '',
                            prefix: prefix?.trim() || '',
                            firstName: first?.trim() || '',
                            lastName: last?.trim() || '',
                            nickname: nick?.trim() || '',
                            phone: phone?.trim() || '',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        count++;
                    }
                }
                
                if (count > 0) {
                    await batch.commit();
                    showNotification(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${count} ‡∏Ñ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                    await loadAdminData();
                } else {
                    showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                }

            } catch (error) {
                console.error('CSV import error:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            } finally {
                hideLoading();
            }
        });

        // Clear All Students
        document.getElementById('clearStudentsBtn').addEventListener('click', () => {
            showConfirmation(
                '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£)',
                async () => {
                    showLoading();
                    try {
                        const studentDocs = await db.collection('applications').get();
                        const applicantDocs = await db.collection('applicants').get();
                        const batch = db.batch();
                        
                        studentDocs.forEach(doc => batch.delete(doc.ref));
                        applicantDocs.forEach(doc => batch.delete(doc.ref));

                        await batch.commit();
                        hideLoading();
                        showNotification('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        await loadAdminData();
                    } catch (error) {
                        console.error('Clear students error:', error);
                        hideLoading();
                        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                    }
                }
            );
        });

        // Export Applicants CSV
        document.getElementById('exportApplicantsBtn').addEventListener('click', async () => {
            showLoading();
            try {
                const applicantsSnapshot = await db.collection('applicants').get();
                const applicantsData = applicantsSnapshot.docs.map(doc => doc.data());

                const header = ["‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", "‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤", "‡∏ä‡∏∑‡πà‡∏≠", "‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•", "‡∏ä‡∏±‡πâ‡∏ô", "‡∏´‡πâ‡∏≠‡∏á", "‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£", "‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£"];
                const rows = [header.join(',')];

                for (const app of applicantsData) {
                    const student = allStudentsData.find(s => s.studentId === app.studentId) || {};
                    const timestamp = app.timestamp ? app.timestamp.toDate().toLocaleString('th-TH') : '';
                    
                    rows.push([
                        app.studentId || '',
                        student.prefix || '',
                        student.firstName || '',
                        student.lastName || '',
                        student.grade || '',
                        student.room || '',
                        student.phone || '',
                        timestamp
                    ].join(','));
                }

                const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + rows.join('\n');
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `applicants_data_${new Date().toISOString().slice(0, 10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } catch (error) {
                console.error('Export CSV error:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV', 'error');
            } finally {
                hideLoading();
            }
        });


        // CRUD Student (Modal Handlers)
        document.getElementById('addStudentBtn').addEventListener('click', () => {
            document.getElementById('addStudentModal').classList.remove('hidden');
        });

        document.getElementById('closeAddStudentModal').addEventListener('click', () => {
            document.getElementById('addStudentModal').classList.add('hidden');
            document.getElementById('addStudentForm').reset();
        });

        document.getElementById('closeEditStudentModal').addEventListener('click', () => {
            document.getElementById('editStudentModal').classList.add('hidden');
            document.getElementById('editStudentForm').reset();
        });

        // Add student form submission
        document.getElementById('addStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            const studentData = {
                studentId: document.getElementById('addStudentId').value.trim(),
                grade: document.getElementById('addGrade').value.trim(),
                room: document.getElementById('addRoom').value.trim(),
                prefix: document.getElementById('addPrefix').value,
                firstName: document.getElementById('addFirstName').value.trim(),
                lastName: document.getElementById('addLastName').value.trim(),
                phone: document.getElementById('addPhone').value.trim(),
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('applications').add(studentData);
                await loadAdminData(); // Refresh data
                document.getElementById('addStudentModal').classList.add('hidden');
                document.getElementById('addStudentForm').reset();
                showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } catch (error) {
                hideLoading();
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
            }
        });

        // Edit Student Functions (Called from HTML)
        window.editStudent = (docId) => {
            const student = allStudentsData.find(s => s.docId === docId);
            if (!student) return;

            document.getElementById('editStudentDocId').value = docId;
            document.getElementById('editStudentId').value = student.studentId || '';
            document.getElementById('editGrade').value = student.grade || '';
            document.getElementById('editRoom').value = student.room || '';
            document.getElementById('editPrefix').value = student.prefix || '';
            document.getElementById('editFirstName').value = student.firstName || '';
            document.getElementById('editLastName').value = student.lastName || '';
            document.getElementById('editPhone').value = student.phone || '';

            document.getElementById('editStudentModal').classList.remove('hidden');
        };

        // Edit student form submission
        document.getElementById('editStudentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            const docId = document.getElementById('editStudentDocId').value;
            const updatedData = {
                grade: document.getElementById('editGrade').value.trim(),
                room: document.getElementById('editRoom').value.trim(),
                prefix: document.getElementById('editPrefix').value,
                firstName: document.getElementById('editFirstName').value.trim(),
                lastName: document.getElementById('editLastName').value.trim(),
                phone: document.getElementById('editPhone').value.trim(),
            };

            try {
                await db.collection('applications').doc(docId).update(updatedData);
                await loadAdminData(); // Refresh data
                document.getElementById('editStudentModal').classList.add('hidden');
                showNotification('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            } catch (error) {
                console.error('Edit student error:', error);
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            } finally {
                hideLoading();
            }
        });


        // Delete Student Function (Called from HTML)
        window.deleteStudent = (docId, studentId) => {
            showConfirmation(
                `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™ ${studentId} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                async () => {
                    showLoading();
                    try {
                        await db.collection('applications').doc(docId).delete();
                        
                        // Also delete any associated application (if exists)
                        const applicantQuery = await db.collection('applicants').where('studentId', '==', studentId).get();
                        if (!applicantQuery.empty) {
                            await db.collection('applicants').doc(applicantQuery.docs[0].id).delete();
                        }

                        hideLoading();
                        showNotification('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        await loadAdminData(); // Refresh data
                    } catch (error) {
                        console.error('Delete student error:', error);
                        hideLoading();
                        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                    }
                }
            );
        };

        // Admin Cancel Application Function (Called from Applicants Table)
        window.cancelApplication = (docId, studentId) => {
            showConfirmation(
                `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™ ${studentId} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
                async () => {
                    showLoading();
                    try {
                        await db.collection('applicants').doc(docId).delete();
                        hideLoading();
                        showNotification('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                        await loadAdminData(); // Refresh data
                    } catch (error) {
                        console.error('Cancel application error:', error);
                        hideLoading();
                        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£', 'error');
                    }
                }
            );
        };
        
        // Confirmation Modal Logic
        document.getElementById('confirmYes').addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            document.getElementById('confirmModal').classList.add('hidden');
        });
        document.getElementById('confirmNo').addEventListener('click', () => {
            document.getElementById('confirmModal').classList.add('hidden');
        });

        // Auto-schedule Check (Every minute)
        setInterval(async () => {
             try {
                const settingsDoc = await db.collection('settings').doc('registration').get();
                const settings = settingsDoc.data();
                if (settings?.autoSchedule && settings.openDateTime && settings.closeDateTime) {
                    const now = new Date();
                    const open = settings.openDateTime.toDate();
                    const close = settings.closeDateTime.toDate();
                    const shouldBeOpen = (now >= open && now <= close);
                    
                    if (settings.isOpen !== shouldBeOpen) {
                        await db.collection('settings').doc('registration').update({ isOpen: shouldBeOpen });
                    }
                }
             } catch(e) { console.error('Auto-schedule check failed', e); }
        }, 60000);

    </script>
</body>
</html>
