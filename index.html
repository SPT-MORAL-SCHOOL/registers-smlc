<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบนักเรียนแกนนำโรงเรียนคุณธรรม สพฐ. โรงเรียนสตรีพัทลุง</title>
    <style>
        /* ------------------ Global Styles and UI Aesthetics ------------------ */
        body { 
            font-family: 'Arial', sans-serif; 
            background: #f0f4f8; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .main-container { 
            width: 95%;
            max-width: 900px; 
            margin: 0 auto; 
        }
        .card { 
            /* เอฟเฟกต์โค้งมนและโปร่งแสง */
            background: rgba(255, 255, 255, 0.7); 
            padding: 30px; 
            border-radius: 20px; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
            backdrop-filter: blur(5px); 
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .header { text-align: center; margin-bottom: 25px; }
        .logo { width: 80px; height: auto; border-radius: 50%; }
        
        /* ------------------ Form and Button Styles ------------------ */
        .input-group input, button { 
            border-radius: 10px; 
            padding: 12px; 
            margin-bottom: 15px; 
            width: 100%; 
            box-sizing: border-box; 
            border: 1px solid #ccc;
        }
        button { cursor: pointer; transition: background-color 0.3s; }
        
        button.student-login { background-color: #3b82f6; color: white; border: none; }
        button.admin-login { background-color: #ef4444; color: white; border: none; }
        button.apply-btn { background-color: #10b981; color: white; border: none; font-size: 1.1rem; }
        button.logout-btn { background-color: #9ca3af; color: white; border: none; margin-bottom: 0; }
        
        /* ------------------ Admin Table Styles ------------------ */
        #applicantsTable { 
            width: 100%; 
            border-collapse: separate; 
            border-spacing: 0; 
            border-radius: 15px; 
            overflow: hidden; /* เพื่อให้ border-radius แสดงผล */
        }
        #applicantsTable th, #applicantsTable td { 
            padding: 12px; 
            text-align: left; 
            border-bottom: 1px solid #e5e7eb;
            background-color: rgba(255, 255, 255, 0.9);
        }
        #applicantsTable th { 
            background-color: #e5e7eb; 
            font-weight: bold;
        }
        
        /* ------------------ Footer Styles ------------------ */
        footer { 
            margin-top: auto; 
            padding: 20px 0;
            width: 100%; 
            text-align: center; 
            color: #6b7280; 
            font-size: 0.85rem; 
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <img src="https://img5.pic.in.th/file/secure-sv1/IMG_25650953161d1c1bbdd8.jpeg" alt="Logo" class="logo">
            <h2>ระบบนักเรียนแกนนำโรงเรียนคุณธรรม สพฐ.</h2>
        </div>

        <div id="loginSection" class="card">
            <h3>เข้าสู่ระบบ</h3>
            
            <form id="studentLoginForm">
                <h4>สำหรับนักเรียน</h4>
                <div class="input-group">
                    <input type="text" id="studentId" placeholder="รหัสนักเรียน" required>
                </div>
                <div class="input-group">
                    <input type="tel" id="phoneNumber" placeholder="เบอร์โทรศัพท์" required>
                </div>
                <button type="submit" class="student-login">เข้าสู่ระบบนักเรียน</button>
            </form>

            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #ccc;">
            
            <form id="adminLoginForm">
                <h4>สำหรับผู้ดูแลระบบ</h4>
                <div class="input-group">
                    <input type="email" id="adminEmail" placeholder="Email (sptmorral@spt.ac.th)" required>
                </div>
                <div class="input-group">
                    <input type="password" id="adminPassword" placeholder="รหัสผ่าน" required>
                </div>
                <button type="submit" class="admin-login">เข้าสู่ระบบผู้ดูแลระบบ</button>
            </form>
        </div>

        <div id="studentDashboardSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>หน้าหลักนักเรียน</h2>
                <button class="logout-btn" id="logoutBtnStudent">ออกจากระบบ</button>
            </div>
            
            <div class="card" id="studentInfoCard">
                <h3>ข้อมูลของคุณ</h3>
                <p><strong>รหัสนักเรียน:</strong> <span id="displayStudentId">...</span></p>
                <p><strong>ชื่อ-สกุล:</strong> <span id="displayFullName">...</span></p>
                <p><strong>ชั้นเรียน:</strong> <span id="displayClass">...</span></p>
                <p><strong>สถานะการสมัคร:</strong> <span id="displayStatus">...</span></p>
            </div>

            <div class="card" id="applicationSection">
                <h3>สมัครเป็นนักเรียนแกนนำโรงเรียนคุณธรรม สพฐ.</h3>
                <form id="applicationForm">
                    <p>กรุณาระบุเหตุผลในการสมัคร:</p>
                    <textarea id="reason" placeholder="เหตุผลในการสมัคร (จำเป็น)" rows="4" style="width: 100%; margin-bottom: 15px; border-radius: 10px; padding: 10px; box-sizing: border-box; border: 1px solid #ccc;"></textarea>
                    <button type="submit" class="apply-btn">สมัครเป็นนักเรียนแกนนำโรงเรียนสตรีพัทลุง</button>
                </form>
            </div>
        </div>

        <div id="adminDashboardSection" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>หน้าผู้ดูแลระบบ - ข้อมูลผู้สมัคร</h2>
                <div>
                    <button class="logout-btn" id="logoutBtnAdmin" style="margin-right: 10px;">ออกจากระบบ</button>
                    <button id="exportCsvBtn" style="background-color: #1c75c5; color: white; padding: 12px; border: none; border-radius: 10px;">ส่งออกไฟล์ CSV</button>
                </div>
            </div>
            
            <div class="card" style="padding: 15px;">
                 <div style="overflow-x: auto;">
                    <table id="applicantsTable">
                        <thead>
                            <tr>
                                <th>รหัสนักเรียน</th>
                                <th>ชื่อ-สกุล</th>
                                <th>ชั้นเรียน</th>
                                <th>เหตุผลสมัคร (ย่อ)</th>
                                <th>วัน-เวลาสมัคร</th>
                                <th>จัดการ</th>
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                 </div>
            </div>
        </div>
        
    </div>

    <footer>
        &copy; 2024 SPT MORAL SCHOOL - โรงเรียนคุณธรรม สพฐ. โรงเรียนสตรีพัทลุง | All Rights Reserved 
    </footer>

    <script type="module">
        // Import Firebase SDKs (v9 syntax)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        // 1. Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDjPKzAY2oyB83jcpXHbBKgK1WZhVmsnHA",
            authDomain: "spt-students.firebaseapp.com",
            projectId: "spt-students",
            storageBucket: "spt-students.firebasestorage.app",
            messagingSenderId: "814089202848",
            appId: "1:814089202848:web:0fa59f182f4feadd702dc5",
            measurementId: "G-MEPRLGW034"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // 2. DOM Elements
        const loginSection = document.getElementById('loginSection');
        const studentDashboardSection = document.getElementById('studentDashboardSection');
        const adminDashboardSection = document.getElementById('adminDashboardSection');
        const studentLoginForm = document.getElementById('studentLoginForm');
        const adminLoginForm = document.getElementById('adminLoginForm');
        const applicationForm = document.getElementById('applicationForm');
        
        let currentStudentId = null;

        // -----------------------------------------------------------
        // 3. Navigation/Authentication Check
        // -----------------------------------------------------------

        function showSection(sectionId) {
            loginSection.style.display = 'none';
            studentDashboardSection.style.display = 'none';
            adminDashboardSection.style.display = 'none';
            
            if (sectionId === 'login') {
                loginSection.style.display = 'block';
            } else if (sectionId === 'student') {
                studentDashboardSection.style.display = 'block';
                loadStudentData();
            } else if (sectionId === 'admin') {
                adminDashboardSection.style.display = 'block';
                loadApplicants();
            }
        }

        function checkAuthStatus() {
            const user = JSON.parse(localStorage.getItem('loggedInUser'));
            
            if (user) {
                if (user.role === 'student') {
                    currentStudentId = user.studentId;
                    showSection('student');
                } else if (user.role === 'admin') {
                    showSection('admin');
                } else {
                    showSection('login');
                }
            } else {
                showSection('login');
            }
        }
        
        function logout() {
            localStorage.removeItem('loggedInUser');
            currentStudentId = null;
            signOut(auth);
            alert('ออกจากระบบสำเร็จ');
            showSection('login');
        }

        // -----------------------------------------------------------
        // 4. Login Handlers
        // -----------------------------------------------------------

        studentLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const studentId = document.getElementById('studentId').value.trim();
            const phoneNumber = document.getElementById('phoneNumber').value.trim();

            try {
                const studentDocRef = doc(db, "applications", studentId);
                const docSnap = await getDoc(studentDocRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.phoneNumber === phoneNumber) {
                        alert("เข้าสู่ระบบสำเร็จ!");
                        localStorage.setItem('loggedInUser', JSON.stringify({ studentId: studentId, role: 'student' }));
                        currentStudentId = studentId;
                        showSection('student');
                    } else {
                        alert("เบอร์โทรศัพท์ไม่ถูกต้อง!");
                    }
                } else {
                    alert("ไม่พบรหัสนักเรียนในระบบ!");
                }
            } catch (error) {
                console.error("Student Login Error: ", error);
                alert("เกิดข้อผิดพลาดในการเข้าสู่ระบบ");
            }
        });

        adminLoginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // ตรวจสอบสิทธิ์ Admin ใน Collection users
                const adminDocRef = doc(db, "users", user.uid);
                const adminDocSnap = await getDoc(adminDocRef);

                if (adminDocSnap.exists() && adminDocSnap.data().role === 'admin') {
                    alert("เข้าสู่ระบบผู้ดูแลระบบสำเร็จ!");
                    localStorage.setItem('loggedInUser', JSON.stringify({ uid: user.uid, role: 'admin' }));
                    showSection('admin');
                } else {
                    await signOut(auth);
                    alert("คุณไม่มีสิทธิ์เข้าถึงหน้านี้!");
                }
            } catch (error) {
                console.error("Admin Login Error: ", error);
                alert("Email หรือรหัสผ่านผู้ดูแลระบบไม่ถูกต้อง");
            }
        });
        
        // -----------------------------------------------------------
        // 5. Student Dashboard Handlers
        // -----------------------------------------------------------

        async function loadStudentData() {
            if (!currentStudentId) return;

            const studentDocRef = doc(db, "applications", currentStudentId);
            try {
                const docSnap = await getDoc(studentDocRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    document.getElementById('displayStudentId').textContent = data.studentId;
                    document.getElementById('displayFullName').textContent = data.fullName || 'ไม่ระบุ';
                    document.getElementById('displayClass').textContent = data.class || 'ไม่ระบุ';
                    
                    const statusText = data.appliedStatus ? '✔️ สมัครแล้ว' : '❌ ยังไม่ได้สมัคร';
                    document.getElementById('displayStatus').textContent = statusText;

                    if (data.appliedStatus) {
                        document.getElementById('applicationSection').innerHTML = '<div style="color: green; font-weight: bold; text-align: center;">คุณได้ทำการสมัครเป็นนักเรียนแกนนำเรียบร้อยแล้ว</div>';
                    } else {
                        // ตรวจสอบให้แน่ใจว่าฟอร์มยังอยู่หากยังไม่ได้สมัคร
                        if (!document.getElementById('applicationForm')) {
                            document.getElementById('applicationSection').innerHTML = `
                                <h3>สมัครเป็นนักเรียนแกนนำโรงเรียนคุณธรรม สพฐ.</h3>
                                <form id="applicationForm">
                                    <p>กรุณาระบุเหตุผลในการสมัคร:</p>
                                    <textarea id="reason" placeholder="เหตุผลในการสมัคร (จำเป็น)" rows="4" style="width: 100%; margin-bottom: 15px; border-radius: 10px; padding: 10px; box-sizing: border-box; border: 1px solid #ccc;"></textarea>
                                    <button type="submit" class="apply-btn">สมัครเป็นนักเรียนแกนนำโรงเรียนสตรีพัทลุง</button>
                                </form>
                            `;
                            document.getElementById('applicationForm').addEventListener('submit', handleApplicationSubmit);
                        }
                    }
                } else {
                    alert('ไม่พบข้อมูลนักเรียน');
                    logout();
                }
            } catch (error) {
                console.error("Error loading student data: ", error);
            }
        }
        
        async function handleApplicationSubmit(e) {
            e.preventDefault();
            const reason = document.getElementById('reason').value.trim();

            if (!reason) {
                alert('กรุณาระบุเหตุผลในการสมัคร');
                return;
            }

            const applicantDocRef = doc(db, "applicants", currentStudentId);
            const studentDocRef = doc(db, "applications", currentStudentId);
            
            try {
                // บันทึก/อัปเดตข้อมูลการสมัคร
                await setDoc(applicantDocRef, {
                    studentId: currentStudentId,
                    applyDate: new Date().toISOString(),
                    reasonForApplying: reason,
                }, { merge: true });

                // อัปเดตสถานะใน applications collection
                await updateDoc(studentDocRef, {
                    appliedStatus: true
                });

                alert('สมัครเป็นนักเรียนแกนนำสำเร็จแล้ว!');
                loadStudentData(); // รีโหลดข้อมูลเพื่ออัปเดต UI
            } catch (error) {
                console.error("Application submission error: ", error);
                alert("เกิดข้อผิดพลาดในการบันทึกข้อมูลการสมัคร");
            }
        };
        
        // ต้อง Attach Event Listener ตอนที่ Form โหลดเสร็จแล้ว (ใน checkAuthStatus/loadStudentData)
        // เพื่อความง่าย จะ Attach ที่นี่ก่อน และจะถูก re-attach ใน loadStudentData หากยังไม่ได้สมัคร
        applicationForm.addEventListener('submit', handleApplicationSubmit);
        document.getElementById('logoutBtnStudent').addEventListener('click', logout);

        // -----------------------------------------------------------
        // 6. Admin Dashboard Handlers
        // -----------------------------------------------------------
        
        document.getElementById('logoutBtnAdmin').addEventListener('click', logout);
        
        async function loadApplicants() {
            const applicantsCol = collection(db, "applicants");
            const applicationsCol = collection(db, "applications");
            
            const applicantsSnap = await getDocs(applicantsCol);
            const applicationsSnap = await getDocs(applicationsCol);
            
            const applicationsMap = {};
            applicationsSnap.forEach(doc => {
                applicationsMap[doc.id] = doc.data();
            });

            const tbody = document.querySelector('#applicantsTable tbody');
            tbody.innerHTML = ''; 

            applicantsSnap.forEach(doc => {
                const data = doc.data();
                const studentId = data.studentId;
                const studentInfo = applicationsMap[studentId] || {}; 

                const row = tbody.insertRow();
                row.insertCell().textContent = studentId;
                row.insertCell().textContent = studentInfo.fullName || '-';
                row.insertCell().textContent = studentInfo.class || '-';
                row.insertCell().textContent = data.reasonForApplying.substring(0, 30) + (data.reasonForApplying.length > 30 ? '...' : '');
                row.insertCell().textContent = new Date(data.applyDate).toLocaleDateString('th-TH');
                
                const actionCell = row.insertCell();
                
                // ปุ่มแก้ไข (ต้องสร้าง Modal/Logic เพิ่มเติม)
                const editBtn = document.createElement('button');
                editBtn.textContent = 'แก้ไข';
                editBtn.style.cssText = 'background-color: #f59e0b; color: white; border: none; padding: 6px 10px; margin-right: 5px; width: auto; border-radius: 6px;';
                editBtn.onclick = () => {
                     alert(`ฟังก์ชันแก้ไขสำหรับนักเรียน ${studentId} (ต้องพัฒนา Modal เพิ่มเติม)`);
                     // ในการใช้งานจริง: เปิด Modal หรือ Form เพื่อแก้ไขข้อมูลใน doc(db, "applicants", studentId)
                };
                actionCell.appendChild(editBtn);

                // ปุ่มลบ
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'ลบ';
                deleteBtn.style.cssText = 'background-color: #ef4444; color: white; border: none; padding: 6px 10px; width: auto; border-radius: 6px;';
                deleteBtn.onclick = () => deleteApplicant(studentId);
                actionCell.appendChild(deleteBtn);
            });
        }
        
        async function deleteApplicant(studentId) {
            if (confirm(`คุณแน่ใจหรือไม่ที่จะลบข้อมูลผู้สมัครรหัส ${studentId} นี้? การดำเนินการนี้ไม่สามารถย้อนกลับได้`)) {
                try {
                    // ลบจาก applicants
                    await deleteDoc(doc(db, "applicants", studentId));
                    // อัปเดตสถานะใน applications ให้กลับเป็น 'ยังไม่ได้สมัคร'
                    await updateDoc(doc(db, "applications", studentId), { appliedStatus: false });
                    
                    alert(`ลบข้อมูลผู้สมัครรหัส ${studentId} สำเร็จ`);
                    loadApplicants(); 
                } catch (error) {
                    console.error("Error deleting document: ", error);
                    alert("เกิดข้อผิดพลาดในการลบข้อมูล");
                }
            }
        }
        
        // ส่งออก CSV
        document.getElementById('exportCsvBtn').addEventListener('click', async () => {
            const applicantsCol = collection(db, "applicants");
            const applicationsCol = collection(db, "applications");
            
            const applicantsSnap = await getDocs(applicantsCol);
            const applicationsSnap = await getDocs(applicationsCol);
            
            const applicationsMap = {};
            applicationsSnap.forEach(doc => { applicationsMap[doc.id] = doc.data(); });

            let csv = 'รหัสนักเรียน,ชื่อ-สกุล,ชั้นเรียน,เบอร์โทร,เหตุผลในการสมัคร,วัน-เวลาสมัคร\n';
            
            const escapeCsv = (str) => {
                if (!str) return '';
                str = String(str).replace(/"/g, '""');
                if (str.includes(',') || str.includes('\n') || str.includes('"')) {
                    return `"${str}"`;
                }
                return str;
            };

            applicantsSnap.forEach(doc => {
                const data = doc.data();
                const studentId = data.studentId;
                const info = applicationsMap[studentId] || {};

                const row = [
                    escapeCsv(studentId),
                    escapeCsv(info.fullName),
                    escapeCsv(info.class),
                    escapeCsv(info.phoneNumber),
                    escapeCsv(data.reasonForApplying),
                    escapeCsv(new Date(data.applyDate).toLocaleString('th-TH'))
                ].join(',');

                csv += row + '\n';
            });

            const blob = new Blob(["\ufeff", csv], { type: 'text/csv;charset=utf-8;' }); 
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', 'applicants_data.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

        // 7. Initial Call
        document.addEventListener('DOMContentLoaded', checkAuthStatus);

    </script>
</body>
</html>
