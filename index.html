<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏° ‚Ä¢ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Prompt', 'Kanit', sans-serif;
            background: #ffffff;
            min-height: 100%;
            font-weight: 400;
        }
        html, body {
            height: 100%;
        }
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            margin-top: 4px;
            box-sizing: border-box;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="p-4 flex items-center justify-center">

    <div id="loadingSpinner" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 hidden">
        <div class="spinner"></div>
    </div>
    
    <div id="notification" class="fixed bottom-5 right-5 p-4 rounded text-white z-50 transition-opacity duration-300 opacity-0"></div>

    <div class="w-full max-w-4xl p-8 glass my-8">
        <h1 class="text-3xl font-bold text-center text-blue-800 mb-6">
            ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏°
        </h1>

        <div id="loginSection" class="max-w-md mx-auto p-6 bg-gray-50 rounded-lg shadow-inner">
            <h2 class="text-xl font-semibold mb-4 text-center">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Admin)</h2>
            <div class="mb-4">
                <label for="email" class="block text-gray-700 font-medium mb-1">Email</label>
                <input type="email" id="email" class="form-input" placeholder="admin@example.com">
            </div>
            <div class="mb-6">
                <label for="password" class="block text-gray-700 font-medium mb-1">Password</label>
                <input type="password" id="password" class="form-input" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            </div>
            <button id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg transition-colors">
                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
            </button>
            <p class="text-sm text-center text-gray-500 mt-4">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</p>
        </div>

        <div id="mainContent" class="hidden">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <span class="text-lg font-medium">‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="userName" class="text-blue-600"></span></span>
                <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>

            <div id="adminSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <p class="mb-4">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞: <span id="adminName" class="font-semibold text-blue-600"></span></p>

                <div class="p-5 border rounded-xl shadow-md mb-6">
                    <h3 class="text-xl font-semibold mb-3">‚öôÔ∏è ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h3>
                    
                    <div class="flex items-center justify-between p-3 bg-gray-100 rounded-lg mb-4">
                        <span class="font-medium text-gray-700">‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" id="manualSwitch" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-gray-100 rounded-lg mb-4">
                        <span class="font-medium text-gray-700">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" value="" id="autoScheduleToggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                        </label>
                    </div>

                    <div id="scheduleInputs" class="mt-4 p-4 border border-purple-300 rounded-lg bg-purple-50 hidden">
                        <h4 class="font-semibold mb-2">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£ (‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢)</h4>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label for="openDateTime" class="block text-sm font-medium text-gray-700">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
                                <input type="datetime-local" id="openDateTime" class="form-input">
                            </div>
                            <div>
                                <label for="closeDateTime" class="block text-sm font-medium text-gray-700">‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
                                <input type="datetime-local" id="closeDateTime" class="form-input">
                            </div>
                        </div>
                        <button id="setScheduleBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 rounded-lg transition-colors">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                        </button>
                    </div>
                </div>

                <div class="p-5 border rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">
                            ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="applicantCount" class="text-blue-600">0</span> ‡∏Ñ‡∏ô)
                        </h3>
                        <button id="exportBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                            üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏´‡∏±‡∏™</th>
                                    <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                                    <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á</th>
                                    <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                                    <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£ (‡πÑ‡∏ó‡∏¢)</th>
                                    <th class="py-3 px-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                </tr>
                            </thead>
                            <tbody id="applicantsTable" class="bg-white divide-y divide-gray-200">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="studentSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h2>
                
                <div class="flex flex-col items-center justify-center space-y-4 mb-8">
                    <p class="text-xl">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="currentStatus" class="font-bold"></span></p>
                    <div id="countdownTimer" class="w-full max-w-sm">
                        </div>
                </div>

                <div id="applicationStatus" class="mb-6 hidden">
                    </div>
                
                <form id="registerForm" class="p-6 border rounded-xl shadow-lg bg-white hidden">
                    <h3 class="text-xl font-semibold mb-4 text-blue-700">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="col-span-1">
                            <label for="studentId" class="block text-gray-700 font-medium mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≥)</label>
                            <input type="text" id="studentId" class="form-input" required pattern="\d+" title="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô">
                        </div>
                        <div class="col-span-1">
                            <label for="grade" class="block text-gray-700 font-medium mb-1">‡∏ä‡∏±‡πâ‡∏ô</label>
                            <select id="grade" class="form-input" required>
                                <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>
                                <option value="‡∏°.4">‡∏°.4</option>
                                <option value="‡∏°.5">‡∏°.5</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mt-4">
                        <div>
                            <label for="prefix" class="block text-gray-700 font-medium mb-1">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                            <select id="prefix" class="form-input" required>
                                <option value="" disabled selected>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                                <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                                <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                            </select>
                        </div>
                        <div>
                            <label for="firstName" class="block text-gray-700 font-medium mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á</label>
                            <input type="text" id="firstName" class="form-input" required>
                        </div>
                        <div>
                            <label for="lastName" class="block text-gray-700 font-medium mb-1">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                            <input type="text" id="lastName" class="form-input" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4 mt-4">
                        <div>
                            <label for="nickname" class="block text-gray-700 font-medium mb-1">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
                            <input type="text" id="nickname" class="form-input">
                        </div>
                        <div>
                            <label for="room" class="block text-gray-700 font-medium mb-1">‡∏´‡πâ‡∏≠‡∏á</label>
                            <input type="number" id="room" class="form-input" required min="1" max="12">
                        </div>
                         <div>
                            <label for="phone" class="block text-gray-700 font-medium mb-1">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå (‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ)</label>
                            <input type="tel" id="phone" class="form-input" required pattern="[0-9]{10}">
                        </div>
                    </div>
                    
                    <button type="submit" class="w-full mt-6 bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition-colors text-lg">
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                    </button>
                </form>
            </div>
        </div>

    </div>

    <script>
        // ====================================================================================
        // START: JAVASCRIPT CODE
        // ====================================================================================

        // [ATTENTION] Replace with your actual Firebase config
        const firebaseConfig = {
  apiKey: "AIzaSyDjPKzAY2oyB83jcpXHbBKgK1WZhVmsnHA",
  authDomain: "spt-students.firebaseapp.com",
  projectId: "spt-students",
  storageBucket: "spt-students.firebasestorage.app",
  messagingSenderId: "814089202848",
  appId: "1:814089202848:web:0fa59f182f4feadd702dc5",
  measurementId: "G-MEPRLGW034"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Utility functions to ensure all time is handled as Thailand Time (UTC+7 / Asia/Bangkok)

        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á Date object ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ (UTC+7)
         * @param {Date} date - Date object ‡∏à‡∏≤‡∏Å Firestore Timestamp
         * @returns {string} ‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢
         */
        function toThaiLocaleString(date) {
            if (!date) return 'N/A';
            // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ß‡∏•‡∏≤ 'Asia/Bangkok' (UTC+7) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            return date.toLocaleString('th-TH', { 
                year: 'numeric', 
                month: 'numeric', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit',
                hour12: false, // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
                timeZone: 'Asia/Bangkok' 
            });
        }

        /**
         * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á Date object ‡∏à‡∏≤‡∏Å Firestore ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DDTThh:mm 
         * ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏™‡πà‡πÉ‡∏ô input[type="datetime-local"] ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢
         * @param {Date} date - Date object ‡∏à‡∏≤‡∏Å Firestore Timestamp
         * @returns {string} ‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input[datetime-local]
         */
        const formatDateTime = (date) => {
            if (!date) return '';

            // ‡πÉ‡∏ä‡πâ Intl.DateTimeFormat ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï 'Asia/Bangkok'
            const formatter = new Intl.DateTimeFormat('en-US', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit',
                hour12: false,
                timeZone: 'Asia/Bangkok'
            });

            const parts = formatter.formatToParts(date);
            const year = parts.find(p => p.type === 'year').value;
            const month = parts.find(p => p.type === 'month').value;
            const day = parts.find(p => p.type === 'day').value;
            let hours = parts.find(p => p.type === 'hour').value;
            const minutes = parts.find(p => p.type === 'minute').value;

            // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á: ‡∏ö‡∏≤‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏≠‡∏≤‡∏à‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ '24' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô '00'
            if (hours === '24') hours = '00';
            
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        };


        // Global variables
        let currentUser = null;
        let isAdmin = false;
        let registrationOpen = true;
        const applicantIds = new Set();
        let autoScheduleInterval = null;


        // UI Elements
        const loadingSpinner = document.getElementById('loadingSpinner');
        const loginSection = document.getElementById('loginSection');
        const mainContent = document.getElementById('mainContent');
        const adminSection = document.getElementById('adminSection');
        const studentSection = document.getElementById('studentSection');
        const registerForm = document.getElementById('registerForm');
        const applicationStatus = document.getElementById('applicationStatus');
        const countdownTimer = document.getElementById('countdownTimer');
        const currentStatus = document.getElementById('currentStatus');


        // Notification function
        function showNotification(message, type = 'info') {
            console.log(`[Notification ${type}]: ${message}`);
            const notifElement = document.getElementById('notification');
            if (notifElement) {
                notifElement.textContent = message;
                notifElement.className = `fixed bottom-5 right-5 p-4 rounded text-white z-50 transition-opacity duration-300 ${
                    type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
                }`;
                notifElement.style.opacity = '1';
                setTimeout(() => {
                    notifElement.style.opacity = '0';
                }, 3000);
            }
        }


        // Login/Logout Handlers
        document.getElementById('loginBtn').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            if (!email || !password) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'error');
                return;
            }
            loadingSpinner.classList.remove('hidden');
            try {
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                showNotification('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                console.error('Login error:', error);
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await auth.signOut();
            } catch (error) {
                console.error('Logout error:', error);
            }
        });


        // Authentication State Observer
        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (user) {
                loginSection.classList.add('hidden');
                mainContent.classList.remove('hidden');
                document.getElementById('userName').textContent = user.email;
                checkAdminStatus(user.uid);
            } else {
                loginSection.classList.remove('hidden');
                mainContent.classList.add('hidden');
                adminSection.classList.add('hidden');
                studentSection.classList.add('hidden');
                isAdmin = false;
                clearInterval(autoScheduleInterval);
            }
        });

        // Check Admin Status
        async function checkAdminStatus(uid) {
            try {
                const adminDoc = await db.collection('admins').doc(uid).get();
                isAdmin = adminDoc.exists;
                if (isAdmin) {
                    adminSection.classList.remove('hidden');
                    studentSection.classList.add('hidden');
                    document.getElementById('adminName').textContent = currentUser.email;
                    loadAdminData();
                } else {
                    adminSection.classList.add('hidden');
                    studentSection.classList.remove('hidden');
                    // document.getElementById('studentName').textContent = currentUser.email; // Uncomment if needed
                    loadStudentData();
                }
            } catch (error) {
                console.error('Error checking admin status:', error);
            }
        }


        // Load data for Student View
        async function loadStudentData() {
            try {
                const settingsDoc = await db.collection('settings').doc('registration').get();
                const settings = settingsDoc.data() || {};
                registrationOpen = settings.isOpen === true;

                const applicantDoc = await db.collection('applicants').doc(currentUser ? currentUser.uid : 'temp_uid_for_anon').get();

                // Update countdown and status
                if (settings.autoSchedule && settings.openDateTime && settings.closeDateTime) {
                    const openDate = settings.openDateTime.toDate();
                    const closeDate = settings.closeDateTime.toDate();
                    
                    // Check if application is currently open
                    const now = new Date();
                    const isAfterOpen = now >= openDate;
                    const isBeforeClose = now < closeDate;

                    if (isAfterOpen && isBeforeClose) {
                        // Open: Show countdown to close
                        currentStatus.textContent = '‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß!';
                        currentStatus.className = 'text-green-600 font-bold';
                        updateCountdown(closeDate, false); // Count down to closing
                    } else if (now < openDate) {
                        // Before open: Show countdown to open
                        currentStatus.textContent = '‚è≥ ‡∏£‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£...';
                        currentStatus.className = 'text-blue-600 font-bold';
                        updateCountdown(openDate, true); // Count down to opening
                    } else {
                        // After close
                        currentStatus.textContent = '‚ùå ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß';
                        currentStatus.className = 'text-red-600 font-bold';
                        countdownTimer.innerHTML = '';
                    }
                    // Update registrationOpen based on schedule
                    registrationOpen = isAfterOpen && isBeforeClose;

                } else if (settings.autoSchedule === false) {
                    currentStatus.textContent = settings.isOpen === true ? '‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á' : '‚ùå ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á';
                    currentStatus.className = settings.isOpen === true ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
                    countdownTimer.innerHTML = '';
                    clearInterval(autoScheduleInterval);
                } else {
                    // Default manual open
                    currentStatus.textContent = registrationOpen ? '‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£' : '‚ùå ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£';
                    currentStatus.className = registrationOpen ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
                    countdownTimer.innerHTML = '';
                    clearInterval(autoScheduleInterval);
                }

                // Show/Hide form and status
                if (applicantDoc.exists) {
                    registerForm.classList.add('hidden');
                    applicationStatus.classList.remove('hidden');
                    const data = applicantDoc.data();
                    // ‡πÉ‡∏ä‡πâ toThaiLocaleString ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                    applicationStatus.innerHTML = `
                        <div class="bg-yellow-100 p-4 rounded-lg text-yellow-800 text-center">
                            <p class="font-bold">üìù ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                            <p>‡∏£‡∏´‡∏±‡∏™: ${data.studentId} | ‡∏ä‡∏∑‡πà‡∏≠: ${data.prefix}${data.firstName} ${data.lastName} | ‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á: ${data.grade}/${data.room}</p>
                            <p class="text-sm mt-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£: <span class="font-semibold">${toThaiLocaleString(data.timestamp.toDate())}</span></p>
                        </div>
                    `;
                } else if (registrationOpen) {
                    registerForm.classList.remove('hidden');
                    applicationStatus.classList.add('hidden');
                } else {
                    registerForm.classList.add('hidden');
                    applicationStatus.classList.remove('hidden');
                    applicationStatus.innerHTML = `<div class="bg-red-100 p-4 rounded-lg text-red-800 text-center font-bold">‚ö†Ô∏è ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>`;
                }

            } catch (error) {
                console.error('Error loading student data:', error);
            }
        }

        // Countdown function
        function updateCountdown(targetDate, isOpening) {
            if (autoScheduleInterval) clearInterval(autoScheduleInterval);

            // Initial run
            let intervalId = setInterval(update, 1000);
            autoScheduleInterval = intervalId;
            update();

            function update() {
                // ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Date object ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                const now = new Date(); 
                const distance = targetDate.getTime() - now.getTime();

                const countdownTimer = document.getElementById('countdownTimer');
                
                if (distance < 0) {
                    clearInterval(intervalId);
                    countdownTimer.innerHTML = '';
                    // Rerun loadStudentData to refresh status
                    loadStudentData(); 
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                const actionText = isOpening ? '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£' : '‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£';
                const bgColor = isOpening ? 'bg-blue-500' : 'bg-orange-500';

                // ‡πÉ‡∏ä‡πâ toThaiLocaleString ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢
                countdownTimer.innerHTML = `
                    <div class="${bgColor} text-white rounded-2xl p-6 shadow-xl">
                        <h3 class="font-bold text-xl mb-3">‚è∞ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤${actionText}</h3>
                        <div class="grid grid-cols-4 gap-4 text-center">
                            <div class="bg-white/20 rounded-lg p-3">
                                <div class="text-2xl font-bold">${days}</div>
                                <div class="text-sm">‡∏ß‡∏±‡∏ô</div>
                            </div>
                            <div class="bg-white/20 rounded-lg p-3">
                                <div class="text-2xl font-bold">${hours}</div>
                                <div class="text-sm">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
                            </div>
                            <div class="bg-white/20 rounded-lg p-3">
                                <div class="text-2xl font-bold">${minutes}</div>
                                <div class="text-sm">‡∏ô‡∏≤‡∏ó‡∏µ</div>
                            </div>
                            <div class="bg-white/20 rounded-lg p-3">
                                <div class="text-2xl font-bold">${seconds}</div>
                                <div class="text-sm">‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
                            </div>
                        </div>
                        <p class="text-sm opacity-90 mt-3">${actionText}: ${toThaiLocaleString(targetDate)}</p>
                    </div>
                `;
            }
        }


        // Submission Handler
        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!registrationOpen) {
                showNotification('‚ùå ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß', 'error');
                return;
            }
            
            // Check if current user exists (should always exist for logged-in users, but good practice)
            if (!currentUser) {
                showNotification('‚ùå ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', 'error');
                return;
            }

            const studentId = document.getElementById('studentId').value.trim();
            const prefix = document.getElementById('prefix').value.trim();
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const nickname = document.getElementById('nickname').value.trim();
            const grade = document.getElementById('grade').value.trim();
            const room = document.getElementById('room').value.trim();
            const phone = document.getElementById('phone').value.trim();

            if (!studentId || !prefix || !firstName || !lastName || !grade || !room || !phone) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }
            
            if (applicantIds.has(studentId)) {
                showNotification('‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', 'error');
                return;
            }

            loadingSpinner.classList.remove('hidden');

            try {
                await db.collection('applicants').doc(currentUser.uid).set({
                    uid: currentUser.uid,
                    studentId,
                    prefix,
                    firstName,
                    lastName,
                    nickname,
                    grade,
                    room,
                    phone,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() // Firestore records time in UTC
                });
                showNotification('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!', 'success');
                registerForm.reset();
                loadStudentData(); // Refresh data and status
            } catch (error) {
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ' + error.message, 'error');
                console.error('Registration error:', error);
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        });


        // Load data for Admin View
        async function loadAdminData() {
            try {
                // Load settings
                const settingsDoc = await db.collection('settings').doc('registration').get();
                const settings = settingsDoc.data() || { isOpen: true, autoSchedule: false };
                
                // Update manual switch and schedule inputs
                document.getElementById('manualSwitch').checked = settings.isOpen === true;
                document.getElementById('autoScheduleToggle').checked = settings.autoSchedule === true;
                document.getElementById('scheduleInputs').classList.toggle('hidden', settings.autoSchedule !== true);

                // ‡πÉ‡∏ä‡πâ formatDateTime ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô input ‡πÇ‡∏î‡∏¢‡∏≠‡∏¥‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢
                if (settings.openDateTime) {
                    const openDate = settings.openDateTime.toDate();
                    document.getElementById('openDateTime').value = formatDateTime(openDate);
                } else {
                    document.getElementById('openDateTime').value = '';
                }
                if (settings.closeDateTime) {
                    const closeDate = settings.closeDateTime.toDate();
                    document.getElementById('closeDateTime').value = formatDateTime(closeDate);
                } else {
                    document.getElementById('closeDateTime').value = '';
                }

                // Load applicants
                const applicantsSnapshot = await db.collection('applicants').orderBy('timestamp', 'desc').get();
                const applicantsTable = document.getElementById('applicantsTable');
                applicantsTable.innerHTML = '';
                // Reset applicant IDs
                applicantIds.clear();
                let count = 0;
                applicantsSnapshot.forEach(doc => {
                    count++;
                    const data = doc.data();
                    applicantIds.add(data.studentId);
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-2">${data.studentId}</td>
                        <td class="py-3 px-2">${data.prefix} ${data.firstName} ${data.lastName}</td>
                        <td class="py-3 px-2">${data.grade}/${data.room}</td>
                        <td class="py-3 px-2">${data.phone}</td>
                        <td class="py-3 px-2">${toThaiLocaleString(data.timestamp?.toDate())}</td>
                        <td class="py-3 px-2">
                            <button onclick="cancelApplication('${doc.id}', '${data.studentId}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                            </button>
                        </td>
                    `;
                    applicantsTable.appendChild(row);
                });
                document.getElementById('applicantCount').textContent = count;

                // Start auto-schedule checker if enabled
                if (settings.autoSchedule === true) {
                    startAutoScheduleChecker();
                } else {
                    clearInterval(autoScheduleInterval);
                }

            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }


        // Admin Action Handlers
        // Manual Switch
        document.getElementById('manualSwitch').addEventListener('change', async (e) => {
            const isOpen = e.target.checked;
            try {
                await db.collection('settings').doc('registration').set({
                    isOpen: isOpen,
                    autoSchedule: false // Disable auto-schedule when manually changing
                }, { merge: true });
                showNotification(`‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${isOpen ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'} ‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á`, 'success');
                loadAdminData(); // Refresh data
            } catch (error) {
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', 'error');
            }
        });

        // Auto Schedule Toggle
        document.getElementById('autoScheduleToggle').addEventListener('change', async (e) => {
            const isAuto = e.target.checked;
            document.getElementById('scheduleInputs').classList.toggle('hidden', !isAuto);
            try {
                await db.collection('settings').doc('registration').set({
                    autoSchedule: isAuto
                }, { merge: true });
                showNotification(`‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ${isAuto ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}`, 'success');
                loadAdminData(); // Refresh data and start/stop checker
            } catch (error) {
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤', 'error');
            }
        });

        // Set schedule
        document.getElementById('setScheduleBtn').addEventListener('click', async () => {
            const openDateTime = document.getElementById('openDateTime').value;
            const closeDateTime = document.getElementById('closeDateTime').value;
            if (!openDateTime || !closeDateTime) {
                showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
                return;
            }
            try {
                // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏™‡∏ï‡∏£‡∏¥‡∏á datetime-local ‡∏ñ‡∏π‡∏Å‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ UTC+7 (+07:00) 
                // ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Date object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Date object ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô UTC ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢
                // Firestore ‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏á Date object ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Timestamp (UTC)
                const openDateThaiTime = openDateTime + ':00.000+07:00';
                const closeDateThaiTime = closeDateTime + ':00.000+07:00';

                await db.collection('settings').doc('registration').set({
                    openDateTime: new Date(openDateThaiTime),
                    closeDateTime: new Date(closeDateThaiTime),
                    autoSchedule: true // Ensure auto-schedule is on when setting schedule
                }, { merge: true });
                showNotification('‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                loadAdminData(); // Refresh data and start checker
            } catch (error) {
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤', 'error');
                console.error('Schedule setting error:', error);
            }
        });


        // Cancel Application (Admin)
        window.cancelApplication = async (docId, studentId) => {
            if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™ ${studentId} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

            try {
                loadingSpinner.classList.remove('hidden');
                await db.collection('applicants').doc(docId).delete();
                showNotification(`‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™ ${studentId} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                loadAdminData();
            } catch (error) {
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£', 'error');
                console.error('Cancellation error:', error);
            } finally {
                loadingSpinner.classList.add('hidden');
            }
        };

        // CSV Export
        document.getElementById('exportBtn').addEventListener('click', async () => {
            try {
                const applicantsSnapshot = await db.collection('applicants').orderBy('timestamp', 'desc').get();
                let csv = '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏ä‡∏±‡πâ‡∏ô,‡∏´‡πâ‡∏≠‡∏á,‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤,‡∏ä‡∏∑‡πà‡∏≠,‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•,‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô,‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå,‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£\n';
                applicantsSnapshot.forEach(doc => {
                    const data = doc.data();
                    // ‡πÉ‡∏ä‡πâ toThaiLocaleString ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ô CSV ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢
                    csv += `${data.studentId},${data.grade},${data.room},${data.prefix},${data.firstName},${data.lastName},${data.nickname},${data.phone},${toThaiLocaleString(data.timestamp?.toDate())}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'applicants_export_' + new Date().toISOString().slice(0, 10) + '.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            } catch (error) {
                showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
                console.error('Export error:', error);
            }
        });


        // Auto Schedule Logic (Admin only)
        function startAutoScheduleChecker() {
            if (autoScheduleInterval) clearInterval(autoScheduleInterval);

            autoScheduleInterval = setInterval(async () => {
                try {
                    const settingsDoc = await db.collection('settings').doc('registration').get();
                    const settings = settingsDoc.data();

                    if (settings && settings.autoSchedule === true && settings.openDateTime && settings.closeDateTime) {
                        const now = new Date();
                        const openDate = settings.openDateTime.toDate();
                        const closeDate = settings.closeDateTime.toDate();
                        
                        let shouldBeOpen = false;
                        
                        // Check if current time is within the schedule (inclusive of open, exclusive of close)
                        if (now >= openDate && now < closeDate) {
                            shouldBeOpen = true;
                        }

                        // Only update Firestore if the current status is different
                        if (settings.isOpen !== shouldBeOpen) {
                            await db.collection('settings').doc('registration').update({
                                isOpen: shouldBeOpen
                            });
                            // Reload admin data to refresh UI status
                            if (isAdmin) {
                                loadAdminData();
                            }
                        }
                    }
                } catch (error) {
                    console.error('Auto-schedule error:', error);
                }
            }, 60000); // Check every minute
        }

        // Initial load check (for users who refresh the page while logged in)
        auth.getRedirectResult().then(() => {
            if (auth.currentUser) {
                checkAdminStatus(auth.currentUser.uid);
            } else {
                // If not logged in, but on the main page, load student data (for anonymous access to status)
                loadStudentData();
            }
        });

        // ====================================================================================
        // END: JAVASCRIPT CODE
        // ====================================================================================
    </script>
</body>
</html>
