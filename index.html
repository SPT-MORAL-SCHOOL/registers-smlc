<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบรับสมัครคณะกรรมการนักเรียนขับเคลื่อนโรงเรียนคุณธรรม สพฐ.</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Sarabun', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100%;
        }
        html, body {
            height: 100%;
        }
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-full">
    <div id="app" class="min-h-full flex flex-col">
        <!-- Header -->
        <header class="glass border-b border-white/20 p-4">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <img src="https://img5.pic.in.th/file/secure-sv1/IMG_25650953161d1c1bbdd8.jpeg" 
                         alt="โลโก้โรงเรียน" class="w-12 h-12 rounded-full object-cover">
                    <div>
                        <h1 class="text-gray-800 font-bold text-lg md:text-xl">ระบบรับสมัครคณะกรรมการนักเรียน</h1>
                        <p class="text-gray-600 text-sm">โรงเรียนคุณธรรม สพฐ. โรงเรียนสตรีพัทลุง</p>
                    </div>
                </div>
                <button id="logoutBtn" class="hidden bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                    ออกจากระบบ
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 p-4">
            <div class="max-w-6xl mx-auto">
                <!-- Login Page -->
                <div id="loginPage" class="fade-in">
                    <div class="max-w-md mx-auto glass rounded-2xl p-8 shadow-2xl">
                        <div class="text-center mb-8">
                            <img src="https://img5.pic.in.th/file/secure-sv1/IMG_25650953161d1c1bbdd8.jpeg" 
                                 alt="โลโก้โรงเรียน" class="w-20 h-20 rounded-full mx-auto mb-4 object-cover">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">เข้าสู่ระบบ</h2>
                            <p class="text-gray-600">Student Morality Leadership Committee</p>
                        </div>

                        <!-- Student Login -->
                        <div id="studentLogin" class="space-y-6">
                            <div>
                                <label for="studentId" class="block text-gray-700 font-medium mb-2">เลขประจำตัวนักเรียน</label>
                                <input type="text" id="studentId" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="กรอกเลขประจำตัวนักเรียน">
                            </div>
                            <div>
                                <label for="phoneNumber" class="block text-gray-700 font-medium mb-2">เบอร์โทรศัพท์</label>
                                <input type="tel" id="phoneNumber" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="กรอกเบอร์โทรศัพท์">
                            </div>
                            <button id="studentLoginBtn" class="w-full btn-primary text-white font-bold py-3 px-6 rounded-xl">
                                เข้าสู่ระบบนักเรียน
                            </button>
                        </div>

                        <div class="my-6 text-center">
                            <span class="text-gray-500">หรือ</span>
                        </div>

                        <!-- Admin Login Toggle -->
                        <button id="adminToggle" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-6 rounded-xl transition-colors border border-gray-300">
                            เข้าสู่ระบบผู้ดูแล
                        </button>

                        <!-- Admin Login (Hidden by default) -->
                        <div id="adminLogin" class="hidden space-y-6 mt-6">
                            <div>
                                <label for="adminEmail" class="block text-gray-700 font-medium mb-2">อีเมลผู้ดูแล</label>
                                <input type="email" id="adminEmail" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="กรอกอีเมลผู้ดูแล">
                            </div>
                            <div>
                                <label for="adminPassword" class="block text-gray-700 font-medium mb-2">รหัสผ่าน</label>
                                <input type="password" id="adminPassword" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="กรอกรหัสผ่าน">
                            </div>
                            <button id="adminLoginBtn" class="w-full btn-primary text-white font-bold py-3 px-6 rounded-xl">
                                เข้าสู่ระบบผู้ดูแล
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Student Dashboard -->
                <div id="studentDashboard" class="hidden fade-in">
                    <div class="max-w-2xl mx-auto glass rounded-2xl p-8 shadow-2xl">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">ข้อมูลนักเรียน</h2>
                            <div id="studentInfo" class="bg-blue-50 border border-blue-200 rounded-xl p-6 text-gray-800">
                                <!-- Student info will be populated here -->
                            </div>
                        </div>

                        <div class="text-center">
                            <div id="registrationStatus" class="mb-6">
                                <!-- Registration status will be shown here -->
                            </div>
                            <button id="registerBtn" class="btn-primary text-white font-bold py-4 px-8 rounded-xl text-lg">
                                สมัครเป็นคณะกรรมการนักเรียนขับเคลื่อนโรงเรียนคุณธรรม
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Admin Dashboard -->
                <div id="adminDashboard" class="hidden fade-in space-y-6">
                    <!-- Admin Controls -->
                    <div class="glass rounded-2xl p-6 shadow-2xl">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">การจัดการระบบ</h2>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-700 font-medium">สถานะการรับสมัคร</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="registrationToggle" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                    </label>
                                </div>
                                <button id="csvImportBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-xl transition-colors">
                                    นำเข้าข้อมูลนักเรียน (CSV)
                                </button>
                                <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">ตั้งเวลาเปิดรับสมัคร</label>
                                    <input type="datetime-local" id="openDateTime" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">ตั้งเวลาปิดรับสมัคร</label>
                                    <input type="datetime-local" id="closeDateTime" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <button id="setScheduleBtn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-medium py-3 px-4 rounded-xl transition-colors">
                                    ตั้งเวลาอัตโนมัติ
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Export Button -->
                    <div class="glass rounded-2xl p-6 shadow-2xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">รายชื่อผู้สมัคร</h3>
                            <button id="exportBtn" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                ส่งออก CSV
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-gray-800">
                                <thead>
                                    <tr class="border-b border-gray-200 bg-gray-50">
                                        <th class="text-left py-3 px-2 font-semibold">รหัสนักเรียน</th>
                                        <th class="text-left py-3 px-2 font-semibold">ชื่อ-นามสกุล</th>
                                        <th class="text-left py-3 px-2 font-semibold">ชั้น</th>
                                        <th class="text-left py-3 px-2 font-semibold">เบอร์โทร</th>
                                        <th class="text-left py-3 px-2 font-semibold">เวลาสมัคร</th>
                                    </tr>
                                </thead>
                                <tbody id="applicantsTable">
                                    <!-- Applicants will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- All Students Table -->
                    <div class="glass rounded-2xl p-6 shadow-2xl">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">ข้อมูลนักเรียนทั้งหมด</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-gray-800">
                                <thead>
                                    <tr class="border-b border-gray-200 bg-gray-50">
                                        <th class="text-left py-3 px-2 font-semibold">รหัสนักเรียน</th>
                                        <th class="text-left py-3 px-2 font-semibold">ชื่อ-นามสกุล</th>
                                        <th class="text-left py-3 px-2 font-semibold">ชั้น</th>
                                        <th class="text-left py-3 px-2 font-semibold">เบอร์โทร</th>
                                        <th class="text-left py-3 px-2 font-semibold">สถานะ</th>
                                    </tr>
                                </thead>
                                <tbody id="allStudentsTable">
                                    <!-- All students will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="glass border-t border-gray-200 p-4 mt-8">
            <div class="max-w-6xl mx-auto text-center text-gray-600 text-sm">
                &copy; 2024 SPT MORAL SCHOOL - โรงเรียนคุณธรรม สพฐ. โรงเรียนสตรีพัทลุง | All Rights Reserved
            </div>
        </footer>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="glass rounded-2xl p-8 text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <p class="text-gray-800 font-medium">กำลังโหลด...</p>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAeb6p1EkjJqbnSb0wG9IV0uv1wSoVWMOI",
            authDomain: "smlc-regis.firebaseapp.com",
            projectId: "smlc-regis",
            storageBucket: "smlc-regis.firebasestorage.app",
            messagingSenderId: "267775551981",
            appId: "1:267775551981:web:e3a27611fa18337128dfe4",
            measurementId: "G-S2S41025VT"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global variables
        let currentUser = null;
        let isAdmin = false;
        let registrationOpen = true;

        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const studentDashboard = document.getElementById('studentDashboard');
        const adminDashboard = document.getElementById('adminDashboard');
        const loadingOverlay = document.getElementById('loadingOverlay');

        // Show loading
        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }

        // Hide loading
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg text-white z-50 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Toggle admin login form
        document.getElementById('adminToggle').addEventListener('click', () => {
            const adminLogin = document.getElementById('adminLogin');
            const studentLogin = document.getElementById('studentLogin');
            
            if (adminLogin.classList.contains('hidden')) {
                adminLogin.classList.remove('hidden');
                studentLogin.classList.add('hidden');
                document.getElementById('adminToggle').textContent = 'เข้าสู่ระบบนักเรียน';
            } else {
                adminLogin.classList.add('hidden');
                studentLogin.classList.remove('hidden');
                document.getElementById('adminToggle').textContent = 'เข้าสู่ระบบผู้ดูแล';
            }
        });

        // Student login
        document.getElementById('studentLoginBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            const studentId = document.getElementById('studentId').value.trim();
            const phoneNumber = document.getElementById('phoneNumber').value.trim();

            if (!studentId || !phoneNumber) {
                showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
                return;
            }

            showLoading();
            try {
                // Check if student exists in database
                const studentQuery = await db.collection('students')
                    .where('studentId', '==', studentId)
                    .where('phone', '==', phoneNumber)
                    .get();

                if (studentQuery.empty) {
                    showNotification('ไม่พบข้อมูลนักเรียน กรุณาตรวจสอบข้อมูลอีกครั้ง', 'error');
                    hideLoading();
                    return;
                }

                const studentData = studentQuery.docs[0].data();
                currentUser = { ...studentData, docId: studentQuery.docs[0].id };
                isAdmin = false;

                showStudentDashboard();
                hideLoading();
                showNotification('เข้าสู่ระบบสำเร็จ', 'success');
            } catch (error) {
                console.error('Login error:', error);
                showNotification('เกิดข้อผิดพลาดในการเข้าสู่ระบบ', 'error');
                hideLoading();
            }
        });

        // Admin login
        document.getElementById('adminLoginBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value.trim();
            const password = document.getElementById('adminPassword').value.trim();

            if (!email || !password) {
                showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
                return;
            }

            showLoading();
            try {
                await auth.signInWithEmailAndPassword(email, password);
                isAdmin = true;
                showAdminDashboard();
                hideLoading();
                showNotification('เข้าสู่ระบบผู้ดูแลสำเร็จ', 'success');
            } catch (error) {
                console.error('Admin login error:', error);
                showNotification('อีเมลหรือรหัสผ่านไม่ถูกต้อง', 'error');
                hideLoading();
            }
        });

        // Show student dashboard
        function showStudentDashboard() {
            loginPage.classList.add('hidden');
            studentDashboard.classList.remove('hidden');
            adminDashboard.classList.add('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');

            // Display student info
            const studentInfo = document.getElementById('studentInfo');
            studentInfo.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
                    <div><strong>รหัสนักเรียน:</strong> ${currentUser.studentId}</div>
                    <div><strong>ชื่อ-นามสกุล:</strong> ${currentUser.prefix} ${currentUser.firstName} ${currentUser.lastName}</div>
                    <div><strong>ชื่อเล่น:</strong> ${currentUser.nickname}</div>
                    <div><strong>ชั้น:</strong> ${currentUser.grade}/${currentUser.room}</div>
                    <div><strong>เบอร์โทร:</strong> ${currentUser.phone}</div>
                </div>
            `;

            checkRegistrationStatus();
        }

        // Check registration status
        async function checkRegistrationStatus() {
            try {
                const applicantQuery = await db.collection('applicants')
                    .where('studentId', '==', currentUser.studentId)
                    .get();

                const registrationStatus = document.getElementById('registrationStatus');
                const registerBtn = document.getElementById('registerBtn');

                if (!applicantQuery.empty) {
                    registrationStatus.innerHTML = `
                        <div class="bg-green-50 border border-green-300 rounded-xl p-4 text-green-800">
                            <h3 class="font-bold text-lg mb-2">✅ สมัครเรียบร้อยแล้ว</h3>
                            <p>คุณได้สมัครเป็นคณะกรรมการนักเรียนขับเคลื่อนโรงเรียนคุณธรรมเรียบร้อยแล้ว</p>
                            <p class="text-sm mt-2">เวลาที่สมัคร: ${applicantQuery.docs[0].data().timestamp?.toDate().toLocaleString('th-TH')}</p>
                        </div>
                    `;
                    registerBtn.style.display = 'none';
                } else {
                    // Check if registration is open
                    const settingsDoc = await db.collection('settings').doc('registration').get();
                    const settings = settingsDoc.data() || {};
                    
                    if (!settings.isOpen) {
                        registrationStatus.innerHTML = `
                            <div class="bg-red-50 border border-red-300 rounded-xl p-4 text-red-800">
                                <h3 class="font-bold text-lg mb-2">❌ ปิดรับสมัครแล้ว</h3>
                                <p>ขณะนี้ไม่เปิดรับสมัครคณะกรรมการนักเรียนขับเคลื่อนโรงเรียนคุณธรรม</p>
                            </div>
                        `;
                        registerBtn.style.display = 'none';
                    } else {
                        registrationStatus.innerHTML = `
                            <div class="bg-blue-50 border border-blue-300 rounded-xl p-4 text-blue-800">
                                <h3 class="font-bold text-lg mb-2">📝 เปิดรับสมัคร</h3>
                                <p>คุณสามารถสมัครเป็นคณะกรรมการนักเรียนขับเคลื่อนโรงเรียนคุณธรรมได้</p>
                            </div>
                        `;
                        registerBtn.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error checking registration status:', error);
            }
        }

        // Register for committee
        document.getElementById('registerBtn').addEventListener('click', async () => {
            showLoading();
            try {
                await db.collection('applicants').add({
                    studentId: currentUser.studentId,
                    prefix: currentUser.prefix,
                    firstName: currentUser.firstName,
                    lastName: currentUser.lastName,
                    nickname: currentUser.nickname,
                    grade: currentUser.grade,
                    room: currentUser.room,
                    phone: currentUser.phone,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                hideLoading();
                showNotification('สมัครเรียบร้อยแล้ว!', 'success');
                checkRegistrationStatus();
            } catch (error) {
                console.error('Registration error:', error);
                hideLoading();
                showNotification('เกิดข้อผิดพลาดในการสมัคร', 'error');
            }
        });

        // Show admin dashboard
        async function showAdminDashboard() {
            loginPage.classList.add('hidden');
            studentDashboard.classList.add('hidden');
            adminDashboard.classList.remove('hidden');
            document.getElementById('logoutBtn').classList.remove('hidden');

            await loadAdminData();
        }

        // Load admin data
        async function loadAdminData() {
            try {
                // Load settings
                const settingsDoc = await db.collection('settings').doc('registration').get();
                const settings = settingsDoc.data() || { isOpen: true };
                
                document.getElementById('registrationToggle').checked = settings.isOpen;

                // Load applicants
                const applicantsSnapshot = await db.collection('applicants').orderBy('timestamp', 'desc').get();
                const applicantsTable = document.getElementById('applicantsTable');
                applicantsTable.innerHTML = '';

                applicantsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-2">${data.studentId}</td>
                        <td class="py-3 px-2">${data.prefix} ${data.firstName} ${data.lastName}</td>
                        <td class="py-3 px-2">${data.grade}/${data.room}</td>
                        <td class="py-3 px-2">${data.phone}</td>
                        <td class="py-3 px-2">${data.timestamp?.toDate().toLocaleString('th-TH') || 'N/A'}</td>
                    `;
                    applicantsTable.appendChild(row);
                });

                // Load all students
                const studentsSnapshot = await db.collection('students').get();
                const allStudentsTable = document.getElementById('allStudentsTable');
                allStudentsTable.innerHTML = '';

                const applicantIds = new Set();
                applicantsSnapshot.forEach(doc => {
                    applicantIds.add(doc.data().studentId);
                });

                studentsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-50';
                    const isApplicant = applicantIds.has(data.studentId);
                    row.innerHTML = `
                        <td class="py-3 px-2">${data.studentId}</td>
                        <td class="py-3 px-2">${data.prefix} ${data.firstName} ${data.lastName}</td>
                        <td class="py-3 px-2">${data.grade}/${data.room}</td>
                        <td class="py-3 px-2">${data.phone}</td>
                        <td class="py-3 px-2">
                            <span class="px-2 py-1 rounded-full text-xs ${isApplicant ? 'bg-green-500' : 'bg-gray-500'}">
                                ${isApplicant ? 'สมัครแล้ว' : 'ยังไม่สมัคร'}
                            </span>
                        </td>
                    `;
                    allStudentsTable.appendChild(row);
                });

            } catch (error) {
                console.error('Error loading admin data:', error);
                showNotification('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
            }
        }

        // Registration toggle
        document.getElementById('registrationToggle').addEventListener('change', async (e) => {
            try {
                await db.collection('settings').doc('registration').set({
                    isOpen: e.target.checked
                }, { merge: true });
                
                showNotification(e.target.checked ? 'เปิดรับสมัครแล้ว' : 'ปิดรับสมัครแล้ว', 'success');
            } catch (error) {
                console.error('Error updating registration status:', error);
                showNotification('เกิดข้อผิดพลาดในการอัพเดทสถานะ', 'error');
            }
        });

        // Set schedule
        document.getElementById('setScheduleBtn').addEventListener('click', async () => {
            const openDateTime = document.getElementById('openDateTime').value;
            const closeDateTime = document.getElementById('closeDateTime').value;

            if (!openDateTime || !closeDateTime) {
                showNotification('กรุณาเลือกวันเวลาให้ครบถ้วน', 'error');
                return;
            }

            try {
                await db.collection('settings').doc('registration').set({
                    openDateTime: new Date(openDateTime),
                    closeDateTime: new Date(closeDateTime),
                    autoSchedule: true
                }, { merge: true });

                showNotification('ตั้งเวลาอัตโนมัติเรียบร้อยแล้ว', 'success');
            } catch (error) {
                console.error('Error setting schedule:', error);
                showNotification('เกิดข้อผิดพลาดในการตั้งเวลา', 'error');
            }
        });

        // CSV Import
        document.getElementById('csvImportBtn').addEventListener('click', () => {
            document.getElementById('csvFileInput').click();
        });

        document.getElementById('csvFileInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            showLoading();
            try {
                const text = await file.text();
                const lines = text.split('\n');
                const batch = db.batch();

                for (let i = 1; i < lines.length; i++) { // Skip header
                    const line = lines[i].trim();
                    if (!line) continue;

                    const [studentId, grade, room, prefix, firstName, lastName, nickname, phone] = line.split(',');
                    
                    if (studentId) {
                        const docRef = db.collection('students').doc();
                        batch.set(docRef, {
                            studentId: studentId.trim(),
                            grade: grade?.trim() || '',
                            room: room?.trim() || '',
                            prefix: prefix?.trim() || '',
                            firstName: firstName?.trim() || '',
                            lastName: lastName?.trim() || '',
                            nickname: nickname?.trim() || '',
                            phone: phone?.trim() || '',
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }

                await batch.commit();
                hideLoading();
                showNotification('นำเข้าข้อมูลเรียบร้อยแล้ว', 'success');
                await loadAdminData();
            } catch (error) {
                console.error('CSV import error:', error);
                hideLoading();
                showNotification('เกิดข้อผิดพลาดในการนำเข้าข้อมูล', 'error');
            }
        });

        // CSV Export
        document.getElementById('exportBtn').addEventListener('click', async () => {
            try {
                const applicantsSnapshot = await db.collection('applicants').orderBy('timestamp', 'desc').get();
                
                let csv = 'รหัสนักเรียน,ชั้น,ห้อง,คำนำหน้า,ชื่อ,นามสกุล,ชื่อเล่น,โทรศัพท์,เวลาสมัคร\n';
                
                applicantsSnapshot.forEach(doc => {
                    const data = doc.data();
                    csv += `${data.studentId},${data.grade},${data.room},${data.prefix},${data.firstName},${data.lastName},${data.nickname},${data.phone},${data.timestamp?.toDate().toLocaleString('th-TH') || 'N/A'}\n`;
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `applicants_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();

                showNotification('ส่งออกข้อมูลเรียบร้อยแล้ว', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showNotification('เกิดข้อผิดพลาดในการส่งออกข้อมูล', 'error');
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                if (isAdmin) {
                    await auth.signOut();
                }
                
                currentUser = null;
                isAdmin = false;
                
                loginPage.classList.remove('hidden');
                studentDashboard.classList.add('hidden');
                adminDashboard.classList.add('hidden');
                document.getElementById('logoutBtn').classList.add('hidden');
                
                // Reset forms
                document.getElementById('studentId').value = '';
                document.getElementById('phoneNumber').value = '';
                document.getElementById('adminEmail').value = '';
                document.getElementById('adminPassword').value = '';
                
                showNotification('ออกจากระบบเรียบร้อยแล้ว', 'success');
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('เกิดข้อผิดพลาดในการออกจากระบบ', 'error');
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            // Check for auto-schedule
            setInterval(async () => {
                try {
                    const settingsDoc = await db.collection('settings').doc('registration').get();
                    const settings = settingsDoc.data();
                    
                    if (settings?.autoSchedule) {
                        const now = new Date();
                        const openTime = settings.openDateTime?.toDate();
                        const closeTime = settings.closeDateTime?.toDate();
                        
                        if (openTime && closeTime) {
                            const shouldBeOpen = now >= openTime && now <= closeTime;
                            
                            if (settings.isOpen !== shouldBeOpen) {
                                await db.collection('settings').doc('registration').update({
                                    isOpen: shouldBeOpen
                                });
                            }
                        }
                    }
                } catch (error) {
                    console.error('Auto-schedule error:', error);
                }
            }, 60000); // Check every minute
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'992e401e162b8955',t:'MTc2MTE5MTIxOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
