<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏° ‚Ä¢ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
            font-family: 'Prompt', 'Kanit', sans-serif;
            background: #ffffff;
            min-height: 100%;
            font-weight: 400;
        }
        html, body {
            height: 100%;
        }
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }
        .btn-primary:hover::before {
            left: 100%;
        }
        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
        }
        .btn-register {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
            font-weight: 700;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .btn-register::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }
        .btn-register:hover::before {
            left: 100%;
        }
        .btn-register:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 20px 40px rgba(255, 107, 107, 0.4);
        }
        .btn-cancel {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .btn-cancel:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(231, 76, 60, 0.3);
        }
        .fade-in {
            animation: fadeIn 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(30px) scale(0.95);
            }
            to { 
                opacity: 1; 
                transform: translateY(0) scale(1);
            }
        }
        h1, h2, h3 {
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .font-medium {
            font-weight: 500;
        }
        .font-bold {
            font-weight: 700;
        }
        input, select {
            font-family: 'Prompt', 'Kanit', sans-serif;
            font-weight: 400;
        }
        .status-success {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            color: white;
            border: none;
        }
        .status-error {
            background: linear-gradient(135deg, #e17055 0%, #d63031 100%);
            color: white;
            border: none;
        }
        .status-info {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            border: none;
        }
    </style>
</head>
<body class="min-h-full">
    <div id="app" class="min-h-full flex flex-col">
        <!-- Header -->
        <header class="glass border-b border-white/20 p-4">
            <div class="max-w-6xl mx-auto flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <img src="https://img5.pic.in.th/file/secure-sv1/IMG_25650953161d1c1bbdd8.jpeg" 
                         alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="w-12 h-12 rounded-full object-cover">
                    <div>
                        <h1 class="text-gray-800 font-bold text-lg md:text-xl">‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
                        <p class="text-gray-600 text-sm">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏° ‡∏™‡∏û‡∏ê. ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á</p>
                    </div>
                </div>
                <button id="logoutBtn" class="hidden bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 p-4">
            <div class="max-w-6xl mx-auto">
                <!-- Login Page -->
                <div id="loginPage" class="fade-in">
                    <div class="max-w-md mx-auto glass rounded-2xl p-8 shadow-2xl">
                        <div class="text-center mb-8">
                            <img src="https://img5.pic.in.th/file/secure-sv1/IMG_25650953161d1c1bbdd8.jpeg" 
                                 alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô" class="w-20 h-20 rounded-full mx-auto mb-4 object-cover">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
                            <p class="text-gray-600">Student Morality Leadership Committee</p>
                        </div>

                        <!-- Student Login -->
                        <div id="studentLogin" class="space-y-6">
                            <div>
                                <label for="studentId" class="block text-gray-700 font-medium mb-2">‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                                <input type="text" id="studentId" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
                            </div>
                            <div>
                                <label for="phoneNumber" class="block text-gray-700 font-medium mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                                <input type="tel" id="phoneNumber" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå">
                            </div>
                            <button id="studentLoginBtn" class="w-full btn-primary text-white font-bold py-3 px-6 rounded-xl">
                                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                            </button>
                        </div>

                        <div class="my-6 text-center">
                            <span class="text-gray-500">‡∏´‡∏£‡∏∑‡∏≠</span>
                        </div>

                        <!-- Admin Login Toggle -->
                        <button id="adminToggle" class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 px-6 rounded-xl transition-colors border border-gray-300">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•
                        </button>

                        <!-- Admin Login (Hidden by default) -->
                        <div id="adminLogin" class="hidden space-y-6 mt-6">
                            <div>
                                <label for="adminEmail" class="block text-gray-700 font-medium mb-2">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</label>
                                <input type="email" id="adminEmail" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•">
                            </div>
                            <div>
                                <label for="adminPassword" class="block text-gray-700 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                                <input type="password" id="adminPassword" class="w-full px-4 py-3 rounded-xl bg-white border border-gray-300 text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
                            </div>
                            <button id="adminLoginBtn" class="w-full btn-primary text-white font-bold py-3 px-6 rounded-xl">
                                ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Student Dashboard -->
                <div id="studentDashboard" class="hidden fade-in">
                    <div class="max-w-2xl mx-auto glass rounded-2xl p-8 shadow-2xl">
                        <div class="text-center mb-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
                            <div id="studentInfo" class="bg-blue-50 border border-blue-200 rounded-xl p-6 text-gray-800">
                                <!-- Student info will be populated here -->
                            </div>
                        </div>

                        <div class="text-center">
                            <div id="countdownTimer" class="mb-6 hidden">
                                <!-- Countdown timer will be shown here -->
                            </div>
                            <div id="registrationStatus" class="mb-6">
                                <!-- Registration status will be shown here -->
                            </div>
                            <button id="registerBtn" class="btn-register text-white font-bold py-5 px-10 rounded-2xl text-xl shadow-2xl">
                                üéØ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏±‡∏ö‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏°
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Admin Dashboard -->
                <div id="adminDashboard" class="hidden fade-in space-y-6">
                    <!-- Admin Controls -->
                    <div class="glass rounded-2xl p-6 shadow-2xl">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö</h2>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-700 font-medium">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="registrationToggle" class="sr-only peer">
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                    </label>
                                </div>
                                <button id="csvImportBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-xl transition-colors">
                                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (CSV)
                                </button>
                                <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                                <button id="addStudentBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-4 rounded-xl transition-colors">
                                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•
                                </button>
                                <button id="clearStudentsBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-4 rounded-xl transition-colors">
                                    ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
                                    <input type="datetime-local" id="openDateTime" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-medium mb-2">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
                                    <input type="datetime-local" id="closeDateTime" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <button id="setScheduleBtn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-medium py-3 px-4 rounded-xl transition-colors mb-2">
                                    ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                                </button>
                                <button id="clearScheduleBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-4 rounded-xl transition-colors">
                                    ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Export Button -->
                    <div class="glass rounded-2xl p-6 shadow-2xl">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h3>
                            <button id="exportBtn" class="bg-green-500 hover:bg-green-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-gray-800">
                                <thead>
                                    <tr class="border-b border-gray-200 bg-gray-50">
                                        <th class="text-left py-3 px-2 font-semibold">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏ä‡∏±‡πâ‡∏ô</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody id="applicantsTable">
                                    <!-- Applicants will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- All Students Table -->
                    <div class="glass rounded-2xl p-6 shadow-2xl">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
                        
                        <!-- Filter Controls -->
                        <div class="mb-6 grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label>
                                <input type="text" id="searchStudent" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏´‡∏±‡∏™, ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏±‡πâ‡∏ô</label>
                                <select id="filterGrade" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">‡∏ó‡∏∏‡∏Å‡∏ä‡∏±‡πâ‡∏ô</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</label>
                                <select id="filterStatus" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                    <option value="applied">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß</option>
                                    <option value="not-applied">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button id="clearFiltersBtn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                                    ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-gray-800">
                                <thead>
                                    <tr class="border-b border-gray-200 bg-gray-50">
                                        <th class="text-left py-3 px-2 font-semibold">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏ä‡∏±‡πâ‡∏ô</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                                        <th class="text-left py-3 px-2 font-semibold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                                    </tr>
                                </thead>
                                <tbody id="allStudentsTable">
                                    <!-- All students will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="glass border-t border-gray-200 p-4 mt-8">
            <div class="max-w-6xl mx-auto text-center text-gray-600 text-sm">
                &copy; 2024 SPT MORAL SCHOOL - ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏ò‡∏£‡∏£‡∏° ‡∏™‡∏û‡∏ê. ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏ï‡∏£‡∏µ‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á | All Rights Reserved
            </div>
        </footer>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="glass rounded-2xl p-8 text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                <p class="text-gray-800 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            </div>
        </div>

        <!-- Add Student Modal -->
        <div id="addStudentModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="glass rounded-2xl p-8 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-6">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h3>
                <form id="addStudentForm" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <input type="text" id="addStudentId" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏±‡πâ‡∏ô</label>
                            <select id="addGrade" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="‡∏°.1">‡∏°.1</option>
                                <option value="‡∏°.2">‡∏°.2</option>
                                <option value="‡∏°.3">‡∏°.3</option>
                                <option value="‡∏°.4">‡∏°.4</option>
                                <option value="‡∏°.5">‡∏°.5</option>
                                <option value="‡∏°.6">‡∏°.6</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡∏´‡πâ‡∏≠‡∏á</label>
                            <select id="addRoom" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                        <select id="addPrefix" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                            <option value="‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢">‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢</option>
                            <option value="‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á">‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á</option>
                            <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                            <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠</label>
                        <input type="text" id="addFirstName" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="addLastName" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                        <input type="text" id="addNickname" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                        <input type="tel" id="addPhone" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="flex-1 bg-green-500 hover:bg-green-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                        </button>
                        <button type="button" id="cancelAddBtn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Edit Student Modal -->
        <div id="editStudentModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="glass rounded-2xl p-8 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-6">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                <form id="editStudentForm" class="space-y-4">
                    <input type="hidden" id="editStudentDocId">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                        <input type="text" id="editStudentId" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏±‡πâ‡∏ô</label>
                            <select id="editGrade" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="‡∏°.1">‡∏°.1</option>
                                <option value="‡∏°.2">‡∏°.2</option>
                                <option value="‡∏°.3">‡∏°.3</option>
                                <option value="‡∏°.4">‡∏°.4</option>
                                <option value="‡∏°.5">‡∏°.5</option>
                                <option value="‡∏°.6">‡∏°.6</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">‡∏´‡πâ‡∏≠‡∏á</label>
                            <select id="editRoom" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</label>
                        <select id="editPrefix" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢">‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢</option>
                            <option value="‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á">‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á</option>
                            <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                            <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠</label>
                        <input type="text" id="editFirstName" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="editLastName" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</label>
                        <input type="text" id="editNickname" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                        <input type="tel" id="editPhone" class="w-full px-3 py-2 rounded-lg bg-white border border-gray-300 text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex space-x-4 pt-4">
                        <button type="submit" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                        </button>
                        <button type="button" id="cancelEditBtn" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="glass rounded-2xl p-8 max-w-md w-full mx-4">
                <h3 class="text-xl font-bold text-gray-800 mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
                <p id="confirmMessage" class="text-gray-700 mb-6"></p>
                <div class="flex space-x-4">
                    <button id="confirmYes" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                        ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
                    </button>
                    <button id="confirmNo" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // [REDACTED: Your Firebase config goes here. Please replace with your actual configuration.]
const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
    appId: "YOUR_APP_ID"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Utility functions to ensure all time is handled as Thailand Time (UTC+7 / Asia/Bangkok)

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á Date object ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ (UTC+7)
 * @param {Date} date - Date object ‡∏à‡∏≤‡∏Å Firestore Timestamp
 * @returns {string} ‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ó‡∏¢
 */
function toThaiLocaleString(date) {
    if (!date) return 'N/A';
    // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡∏ï‡πÄ‡∏ß‡∏•‡∏≤ 'Asia/Bangkok' (UTC+7) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
    return date.toLocaleString('th-TH', { 
        year: 'numeric', 
        month: 'numeric', 
        day: 'numeric', 
        hour: '2-digit', 
        minute: '2-digit', 
        second: '2-digit',
        hour12: false, // ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
        timeZone: 'Asia/Bangkok' 
    });
}

/**
 * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏õ‡∏•‡∏á Date object ‡∏à‡∏≤‡∏Å Firestore ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö YYYY-MM-DDTThh:mm 
 * ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏™‡πà‡πÉ‡∏ô input[type="datetime-local"] ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢
 * @param {Date} date - Date object ‡∏à‡∏≤‡∏Å Firestore Timestamp
 * @returns {string} ‡∏™‡∏ï‡∏£‡∏¥‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input[datetime-local]
 */
const formatDateTime = (date) => {
    if (!date) return '';

    // ‡πÉ‡∏ä‡πâ Intl.DateTimeFormat ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï 'Asia/Bangkok'
    const formatter = new Intl.DateTimeFormat('en-US', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit',
        hour12: false,
        timeZone: 'Asia/Bangkok'
    });

    const parts = formatter.formatToParts(date);
    const year = parts.find(p => p.type === 'year').value;
    const month = parts.find(p => p.type === 'month').value;
    const day = parts.find(p => p.type === 'day').value;
    let hours = parts.find(p => p.type === 'hour').value;
    const minutes = parts.find(p => p.type === 'minute').value;

    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö 24 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á: ‡∏ö‡∏≤‡∏á‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏≠‡∏≤‡∏à‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ '24' ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏Ñ‡∏∑‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô '00'
    if (hours === '24') hours = '00';
    
    return `${year}-${month}-${day}T${hours}:${minutes}`;
};


// Global variables
let currentUser = null;
let isAdmin = false;
let registrationOpen = true;
const applicantIds = new Set();
let autoScheduleInterval = null;


// UI Elements
const loadingSpinner = document.getElementById('loadingSpinner');
const loginSection = document.getElementById('loginSection');
const mainContent = document.getElementById('mainContent');
const adminSection = document.getElementById('adminSection');
const studentSection = document.getElementById('studentSection');
const registerForm = document.getElementById('registerForm');
const applicationStatus = document.getElementById('applicationStatus');
const countdownTimer = document.getElementById('countdownTimer');
const currentStatus = document.getElementById('currentStatus');


// Notification function
function showNotification(message, type = 'info') {
    // Assuming a simple notification implementation exists
    console.log(`[Notification ${type}]: ${message}`);
    // In a real application, you'd show a modal or toast notification here.
    const notifElement = document.getElementById('notification');
    if (notifElement) {
        notifElement.textContent = message;
        notifElement.className = `fixed bottom-5 right-5 p-4 rounded text-white z-50 transition-opacity duration-300 ${
            type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'
        }`;
        notifElement.style.opacity = '1';
        setTimeout(() => {
            notifElement.style.opacity = '0';
        }, 3000);
    }
}


// Login/Logout Handlers
document.getElementById('loginBtn').addEventListener('click', async () => {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    if (!email || !password) {
        showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'error');
        return;
    }
    loadingSpinner.classList.remove('hidden');
    try {
        await auth.signInWithEmailAndPassword(email, password);
    } catch (error) {
        showNotification('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
        console.error('Login error:', error);
    } finally {
        loadingSpinner.classList.add('hidden');
    }
});

document.getElementById('logoutBtn').addEventListener('click', async () => {
    try {
        await auth.signOut();
    } catch (error) {
        console.error('Logout error:', error);
    }
});


// Authentication State Observer
auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
        loginSection.classList.add('hidden');
        mainContent.classList.remove('hidden');
        checkAdminStatus(user.uid);
    } else {
        loginSection.classList.remove('hidden');
        mainContent.classList.add('hidden');
        adminSection.classList.add('hidden');
        studentSection.classList.add('hidden');
        isAdmin = false;
        clearInterval(autoScheduleInterval);
    }
});

// Check Admin Status
async function checkAdminStatus(uid) {
    try {
        const adminDoc = await db.collection('admins').doc(uid).get();
        isAdmin = adminDoc.exists;
        if (isAdmin) {
            adminSection.classList.remove('hidden');
            studentSection.classList.add('hidden');
            document.getElementById('adminName').textContent = currentUser.email;
            loadAdminData();
        } else {
            adminSection.classList.add('hidden');
            studentSection.classList.remove('hidden');
            document.getElementById('studentName').textContent = currentUser.email;
            loadStudentData();
        }
    } catch (error) {
        console.error('Error checking admin status:', error);
    }
}


// Load data for Student View
async function loadStudentData() {
    try {
        const settingsDoc = await db.collection('settings').doc('registration').get();
        const settings = settingsDoc.data() || {};
        registrationOpen = settings.isOpen === true;

        const applicantDoc = await db.collection('applicants').doc(currentUser.uid).get();

        // Update countdown and status
        if (settings.autoSchedule && settings.openDateTime && settings.closeDateTime) {
            const openDate = settings.openDateTime.toDate();
            const closeDate = settings.closeDateTime.toDate();
            
            // Check if application is currently open
            const now = new Date();
            const isAfterOpen = now >= openDate;
            const isBeforeClose = now < closeDate;

            if (isAfterOpen && isBeforeClose) {
                // Open: Show countdown to close
                currentStatus.textContent = '‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß!';
                currentStatus.className = 'text-green-600 font-bold';
                updateCountdown(closeDate, false); // Count down to closing
            } else if (now < openDate) {
                // Before open: Show countdown to open
                currentStatus.textContent = '‚è≥ ‡∏£‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£...';
                currentStatus.className = 'text-blue-600 font-bold';
                updateCountdown(openDate, true); // Count down to opening
            } else {
                // After close
                currentStatus.textContent = '‚ùå ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß';
                currentStatus.className = 'text-red-600 font-bold';
                countdownTimer.innerHTML = '';
            }
            // Update registrationOpen based on schedule
            registrationOpen = isAfterOpen && isBeforeClose;

        } else if (settings.autoSchedule === false) {
             currentStatus.textContent = settings.isOpen === true ? '‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á' : '‚ùå ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á';
             currentStatus.className = settings.isOpen === true ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
             countdownTimer.innerHTML = '';
        } else {
            // Default manual open
             currentStatus.textContent = registrationOpen ? '‚úÖ ‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£' : '‚ùå ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£';
             currentStatus.className = registrationOpen ? 'text-green-600 font-bold' : 'text-red-600 font-bold';
             countdownTimer.innerHTML = '';
        }

        // Show/Hide form and status
        if (applicantDoc.exists) {
            registerForm.classList.add('hidden');
            applicationStatus.classList.remove('hidden');
            const data = applicantDoc.data();
            // ‡πÉ‡∏ä‡πâ toThaiLocaleString ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            applicationStatus.innerHTML = `
                <div class="bg-yellow-100 p-4 rounded-lg text-yellow-800 text-center">
                    <p class="font-bold">üìù ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                    <p>‡∏£‡∏´‡∏±‡∏™: ${data.studentId} | ‡∏ä‡∏∑‡πà‡∏≠: ${data.prefix}${data.firstName} ${data.lastName} | ‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á: ${data.grade}/${data.room}</p>
                    <p class="text-sm mt-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏±‡∏Ñ‡∏£: <span class="font-semibold">${toThaiLocaleString(data.timestamp.toDate())}</span></p>
                </div>
            `;
        } else if (registrationOpen) {
            registerForm.classList.remove('hidden');
            applicationStatus.classList.add('hidden');
        } else {
            registerForm.classList.add('hidden');
            applicationStatus.classList.remove('hidden');
            applicationStatus.innerHTML = `<div class="bg-red-100 p-4 rounded-lg text-red-800 text-center font-bold">‚ö†Ô∏è ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ</div>`;
        }

    } catch (error) {
        console.error('Error loading student data:', error);
    }
}

// Countdown function
function updateCountdown(targetDate, isOpening) {
    if (autoScheduleInterval) clearInterval(autoScheduleInterval);

    // Initial run
    let intervalId = setInterval(update, 1000);
    autoScheduleInterval = intervalId;
    update();

    function update() {
        // ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á Date object ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        const now = new Date(); 
        const distance = targetDate.getTime() - now.getTime();

        const countdownTimer = document.getElementById('countdownTimer');
        
        if (distance < 0) {
            clearInterval(intervalId);
            countdownTimer.innerHTML = '';
            // Rerun loadStudentData to refresh status
            loadStudentData(); 
            return;
        }

        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        const actionText = isOpening ? '‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£' : '‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£';
        const bgColor = isOpening ? 'bg-blue-500' : 'bg-orange-500';

        // ‡πÉ‡∏ä‡πâ toThaiLocaleString ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢
        countdownTimer.innerHTML = `
            <div class="${bgColor} text-white rounded-2xl p-6 shadow-xl">
                <h3 class="font-bold text-xl mb-3">‚è∞ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤${actionText}</h3>
                <div class="grid grid-cols-4 gap-4 text-center">
                    <div class="bg-white/20 rounded-lg p-3">
                        <div class="text-2xl font-bold">${days}</div>
                        <div class="text-sm">‡∏ß‡∏±‡∏ô</div>
                    </div>
                    <div class="bg-white/20 rounded-lg p-3">
                        <div class="text-2xl font-bold">${hours}</div>
                        <div class="text-sm">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</div>
                    </div>
                    <div class="bg-white/20 rounded-lg p-3">
                        <div class="text-2xl font-bold">${minutes}</div>
                        <div class="text-sm">‡∏ô‡∏≤‡∏ó‡∏µ</div>
                    </div>
                    <div class="bg-white/20 rounded-lg p-3">
                        <div class="text-2xl font-bold">${seconds}</div>
                        <div class="text-sm">‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ</div>
                    </div>
                </div>
                <p class="text-sm opacity-90 mt-3">${actionText}: ${toThaiLocaleString(targetDate)}</p>
            </div>
        `;
    }
}


// Submission Handler
registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!registrationOpen) {
        showNotification('‚ùå ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏õ‡∏¥‡∏î‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÅ‡∏•‡πâ‡∏ß', 'error');
        return;
    }

    const studentId = document.getElementById('studentId').value.trim();
    const prefix = document.getElementById('prefix').value.trim();
    const firstName = document.getElementById('firstName').value.trim();
    const lastName = document.getElementById('lastName').value.trim();
    const nickname = document.getElementById('nickname').value.trim();
    const grade = document.getElementById('grade').value.trim();
    const room = document.getElementById('room').value.trim();
    const phone = document.getElementById('phone').value.trim();

    if (!studentId || !prefix || !firstName || !lastName || !grade || !room || !phone) {
        showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
        return;
    }
    
    if (applicantIds.has(studentId)) {
         showNotification('‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', 'error');
         return;
    }

    loadingSpinner.classList.remove('hidden');

    try {
        await db.collection('applicants').doc(currentUser.uid).set({
            uid: currentUser.uid,
            studentId,
            prefix,
            firstName,
            lastName,
            nickname,
            grade,
            room,
            phone,
            timestamp: firebase.firestore.FieldValue.serverTimestamp() // Firestore records time in UTC
        });
        showNotification('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!', 'success');
        registerForm.reset();
        loadStudentData(); // Refresh data and status
    } catch (error) {
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ' + error.message, 'error');
        console.error('Registration error:', error);
    } finally {
        loadingSpinner.classList.add('hidden');
    }
});


// Load data for Admin View
async function loadAdminData() {
    try {
        // Load settings
        const settingsDoc = await db.collection('settings').doc('registration').get();
        const settings = settingsDoc.data() || { isOpen: true, autoSchedule: false };
        
        // Update manual switch and schedule inputs
        document.getElementById('manualSwitch').checked = settings.isOpen === true;
        document.getElementById('autoScheduleToggle').checked = settings.autoSchedule === true;
        document.getElementById('scheduleInputs').classList.toggle('hidden', settings.autoSchedule !== true);

        // ‡πÉ‡∏ä‡πâ formatDateTime ‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô input ‡πÇ‡∏î‡∏¢‡∏≠‡∏¥‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢
        if (settings.openDateTime) {
            const openDate = settings.openDateTime.toDate();
            document.getElementById('openDateTime').value = formatDateTime(openDate);
        } else {
             document.getElementById('openDateTime').value = '';
        }
        if (settings.closeDateTime) {
            const closeDate = settings.closeDateTime.toDate();
            document.getElementById('closeDateTime').value = formatDateTime(closeDate);
        } else {
             document.getElementById('closeDateTime').value = '';
        }

        // Load applicants
        const applicantsSnapshot = await db.collection('applicants').orderBy('timestamp', 'desc').get();
        const applicantsTable = document.getElementById('applicantsTable');
        applicantsTable.innerHTML = '';
        // Reset applicant IDs
        applicantIds.clear();
        let count = 0;
        applicantsSnapshot.forEach(doc => {
            count++;
            const data = doc.data();
            applicantIds.add(data.studentId);
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-200 hover:bg-gray-50';
            row.innerHTML = `
                <td class="py-3 px-2">${data.studentId}</td>
                <td class="py-3 px-2">${data.prefix} ${data.firstName} ${data.lastName}</td>
                <td class="py-3 px-2">${data.grade}/${data.room}</td>
                <td class="py-3 px-2">${data.phone}</td>
                <td class="py-3 px-2">${toThaiLocaleString(data.timestamp?.toDate())}</td>
                <td class="py-3 px-2">
                    <button onclick="cancelApplication('${doc.id}', '${data.studentId}')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£
                    </button>
                </td>
            `;
            applicantsTable.appendChild(row);
        });
        document.getElementById('applicantCount').textContent = count;

        // Start auto-schedule checker if enabled
        if (settings.autoSchedule === true) {
            startAutoScheduleChecker();
        } else {
            clearInterval(autoScheduleInterval);
        }

    } catch (error) {
        console.error('Error loading admin data:', error);
    }
}


// Admin Action Handlers
// Manual Switch
document.getElementById('manualSwitch').addEventListener('change', async (e) => {
    const isOpen = e.target.checked;
    try {
        await db.collection('settings').doc('registration').set({
            isOpen: isOpen,
            autoSchedule: false // Disable auto-schedule when manually changing
        }, { merge: true });
        showNotification(`‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ${isOpen ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'} ‡∏£‡∏±‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á`, 'success');
        loadAdminData(); // Refresh data
    } catch (error) {
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', 'error');
    }
});

// Auto Schedule Toggle
document.getElementById('autoScheduleToggle').addEventListener('change', async (e) => {
    const isAuto = e.target.checked;
    document.getElementById('scheduleInputs').classList.toggle('hidden', !isAuto);
    try {
        await db.collection('settings').doc('registration').set({
            autoSchedule: isAuto
        }, { merge: true });
        showNotification(`‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ${isAuto ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}`, 'success');
        loadAdminData(); // Refresh data and start/stop checker
    } catch (error) {
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤', 'error');
    }
});

// Set schedule
document.getElementById('setScheduleBtn').addEventListener('click', async () => {
    const openDateTime = document.getElementById('openDateTime').value;
    const closeDateTime = document.getElementById('closeDateTime').value;
    if (!openDateTime || !closeDateTime) {
        showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'error');
        return;
    }
    try {
        // [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç] ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏™‡∏ï‡∏£‡∏¥‡∏á datetime-local ‡∏ñ‡∏π‡∏Å‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ UTC+7 (+07:00) 
        // ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Date object ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ Date object ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô UTC ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢
        // Firestore ‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏á Date object ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Timestamp (UTC)
        const openDateThaiTime = openDateTime + ':00.000+07:00';
        const closeDateThaiTime = closeDateTime + ':00.000+07:00';

        await db.collection('settings').doc('registration').set({
            openDateTime: new Date(openDateThaiTime),
            closeDateTime: new Date(closeDateThaiTime),
            autoSchedule: true // Ensure auto-schedule is on when setting schedule
        }, { merge: true });
        showNotification('‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
        loadAdminData(); // Refresh data and start checker
    } catch (error) {
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤', 'error');
        console.error('Schedule setting error:', error);
    }
});


// Cancel Application (Admin)
window.cancelApplication = async (docId, studentId) => {
    if (!confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™ ${studentId} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) return;

    try {
        loadingSpinner.classList.remove('hidden');
        await db.collection('applicants').doc(docId).delete();
        showNotification(`‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™ ${studentId} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
        loadAdminData();
    } catch (error) {
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£', 'error');
        console.error('Cancellation error:', error);
    } finally {
        loadingSpinner.classList.add('hidden');
    }
};

// CSV Export
document.getElementById('exportBtn').addEventListener('click', async () => {
    try {
        const applicantsSnapshot = await db.collection('applicants').orderBy('timestamp', 'desc').get();
        let csv = '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏ä‡∏±‡πâ‡∏ô,‡∏´‡πâ‡∏≠‡∏á,‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤,‡∏ä‡∏∑‡πà‡∏≠,‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•,‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô,‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå,‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£\n';
        applicantsSnapshot.forEach(doc => {
            const data = doc.data();
            // ‡πÉ‡∏ä‡πâ toThaiLocaleString ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ô CSV ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢
            csv += `${data.studentId},${data.grade},${data.room},${data.prefix},${data.firstName},${data.lastName},${data.nickname},${data.phone},${toThaiLocaleString(data.timestamp?.toDate())}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'applicants_export_' + new Date().toISOString().slice(0, 10) + '.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showNotification('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
    } catch (error) {
        showNotification('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
        console.error('Export error:', error);
    }
});


// Auto Schedule Logic (Admin only)
function startAutoScheduleChecker() {
    if (autoScheduleInterval) clearInterval(autoScheduleInterval);

    autoScheduleInterval = setInterval(async () => {
        try {
            const settingsDoc = await db.collection('settings').doc('registration').get();
            const settings = settingsDoc.data();

            if (settings && settings.autoSchedule === true && settings.openDateTime && settings.closeDateTime) {
                const now = new Date();
                const openDate = settings.openDateTime.toDate();
                const closeDate = settings.closeDateTime.toDate();
                
                let shouldBeOpen = false;
                
                // Check if current time is within the schedule (inclusive of open, exclusive of close)
                if (now >= openDate && now < closeDate) {
                    shouldBeOpen = true;
                }

                // Only update Firestore if the current status is different
                if (settings.isOpen !== shouldBeOpen) {
                    await db.collection('settings').doc('registration').update({
                        isOpen: shouldBeOpen
                    });
                }
            }
        } catch (error) {
            console.error('Auto-schedule error:', error);
        }
    }, 60000); // Check every minute
}

// Initial load for admin (if already logged in)
if (currentUser && isAdmin) {
    loadAdminData();
}

    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'992e84c6570a7325',t:'MTc2MTE5NDAzMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
